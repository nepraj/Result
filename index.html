<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExamPortal Elite - Professional Result System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-bg { background-color: rgba(17, 24, 39, 0.7); backdrop-filter: blur(4px); }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #4f46e5; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .result-card-a4 {
            width: 794px;
            height: 1123px;
            background: white;
            position: relative;
            font-family: 'Arial', sans-serif;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .watermark-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 120px;
            color: rgba(0,0,0,0.03);
            font-weight: bold;
            z-index: 0;
            pointer-events: none;
        }

        #capture-zone { position: fixed; left: -9999px; top: 0; z-index: -1; }
        
        @media print {
            body * { visibility: hidden; }
            .result-card-a4, .result-card-a4 * { visibility: visible; }
            .result-card-a4 { position: absolute; left: 0; top: 0; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased selection:bg-indigo-100 selection:text-indigo-700">

    <div id="capture-zone"></div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-2xl opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center gap-3">
        <i class="fas fa-info-circle text-indigo-400"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <nav class="bg-white shadow-md sticky top-0 z-40 border-b border-gray-100">
        <div class="container mx-auto px-4 md:px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2 text-2xl font-bold text-gray-900 tracking-tight">
                <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white text-lg shadow-indigo-200 shadow-lg">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span id="nav-title">Gurukul Public School</span>
            </div>
            <div class="flex gap-2">
                <button onclick="switchView('student')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition">Result Search</button>
                <button onclick="switchView('login')" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 rounded-lg transition shadow-md">Admin</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8 min-h-[calc(100vh-80px)]">

        <section id="view-student" class="max-w-2xl mx-auto fade-in">
            <div class="text-center mb-10 space-y-2">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900" id="exam-title-display">Number System and Series Summation</h1>
                <p class="text-gray-500" id="exam-subtitle-display">Enter your official credentials to view the result.</p>
            </div>

            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-gray-100 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                
                <div class="flex flex-col gap-4">
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Search Candidate</label>
                    <div class="flex gap-2">
                        <input type="text" id="search-input" placeholder="Enter Roll Number or Name..." class="flex-1 bg-gray-50 border border-gray-200 text-gray-900 text-lg rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 outline-none transition" onkeypress="if(event.key==='Enter') findStudent()">
                        <button onclick="findStudent()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl px-6 py-3 transition shadow-lg shadow-indigo-200">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <p id="search-error" class="text-red-500 text-sm font-medium hidden"><i class="fas fa-exclamation-circle mr-1"></i> No record found.</p>
                </div>
            </div>

            <div id="result-display" class="hidden mt-8 bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-200 fade-in">
                <div class="bg-gray-900 p-6 flex justify-between items-center text-white">
                    <div>
                        <h2 class="text-2xl font-bold" id="disp-name">Student Name</h2>
                        <p class="text-gray-400 font-mono">Roll: <span id="disp-roll">1001</span></p>
                    </div>
                    <div class="text-center">
                        <span class="block text-xs text-gray-400 uppercase font-bold">Overall Rank</span>
                        <span class="text-3xl font-bold text-yellow-400" id="disp-rank">#1</span>
                    </div>
                </div>

                <div class="p-6 grid grid-cols-2 md:grid-cols-5 gap-4 bg-gray-50 border-b">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center">
                        <div class="text-xs text-gray-500 font-bold uppercase">Total Qs</div>
                        <div class="text-2xl font-bold text-gray-800" id="disp-total">100</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 text-center">
                        <div class="text-xs text-blue-600 font-bold uppercase">Attempted</div>
                        <div class="text-2xl font-bold text-blue-600" id="disp-attempted">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-green-100 text-center">
                        <div class="text-xs text-green-600 font-bold uppercase">Correct</div>
                        <div class="text-2xl font-bold text-green-600" id="disp-right">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-red-100 text-center">
                        <div class="text-xs text-red-600 font-bold uppercase">Wrong</div>
                        <div class="text-2xl font-bold text-red-600" id="disp-wrong">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-indigo-100 text-center">
                        <div class="text-xs text-indigo-600 font-bold uppercase">Marks</div>
                        <div class="text-2xl font-bold text-indigo-600" id="disp-marks">0</div>
                    </div>
                </div>

                <div class="p-6 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="text-4xl font-bold text-gray-800" id="disp-percent">0%</div>
                        <div id="disp-badge" class="px-3 py-1 rounded-full text-sm font-bold uppercase bg-gray-200 text-gray-600">Status</div>
                    </div>
                    
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="shareResultWhatsApp()" class="flex-1 md:flex-none px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-sm transition flex items-center justify-center gap-2">
                            <i class="fab fa-whatsapp"></i> Share
                        </button>
                        <button onclick="generateResultJPG('student')" class="flex-1 md:flex-none px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-sm transition flex items-center justify-center gap-2">
                            <i class="fas fa-image"></i> Download JPG
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-login" class="hidden max-w-md mx-auto fade-in pt-10">
            <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200 text-center">
                <div class="mb-6 inline-block p-4 rounded-full bg-indigo-50 text-indigo-600 text-3xl">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Admin Portal</h2>
                <input type="password" id="admin-pass" placeholder="Enter Password" class="w-full mb-4 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" onkeypress="if(event.key==='Enter') handleLogin()">
                <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">Access Dashboard</button>
                <p id="login-msg" class="text-red-500 mt-3 text-sm hidden">Invalid Credentials</p>
            </div>
        </section>

        <section id="view-dashboard" class="hidden w-full max-w-7xl mx-auto fade-in">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4 pb-6 border-b border-gray-200">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900">Dashboard</h2>
                    <p class="text-gray-500 mt-1">Manage Results, Rank List & Configuration</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="openModal('add')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">
                        <i class="fas fa-plus mr-2"></i> Add Student
                    </button>
                    <button onclick="generateMeritListJPG()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition">
                        <i class="fas fa-image mr-2"></i> Merit List JPG
                    </button>
                    <button onclick="logout()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-50 transition">
                        Log Out
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                    <div class="font-bold text-gray-700 uppercase text-sm tracking-wider">Live Ranking Table</div>
                    <div class="text-sm text-gray-500">Total Records: <span id="total-count" class="font-bold text-gray-900">0</span></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase font-bold">
                            <tr>
                                <th class="p-4">Rank</th>
                                <th class="p-4">Roll</th>
                                <th class="p-4">Name</th>
                                <th class="p-4 text-center">Marks</th>
                                <th class="p-4 text-center">%</th>
                                <th class="p-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-tbody" class="divide-y divide-gray-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <div id="modal" class="fixed inset-0 modal-bg hidden z-50 flex items-center justify-center fade-in">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden m-4">
            <div class="bg-gray-900 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold" id="modal-title">Add Student</h3>
                <button onclick="closeModal()" class="hover:text-gray-300"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-roll-ref">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Full Name</label>
                    <input id="inp-name" type="text" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Roll No</label>
                        <input id="inp-roll" type="text" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Total Qs</label>
                        <input id="inp-total" type="number" value="100" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded-lg border">
                    <div>
                        <label class="block text-xs font-bold text-green-600 uppercase mb-1">Correct (+4)</label>
                        <input id="inp-right" type="number" class="w-full border border-green-200 bg-white p-2 rounded font-bold text-green-700 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-red-600 uppercase mb-1">Wrong (-1)</label>
                        <input id="inp-wrong" type="number" class="w-full border border-red-200 bg-white p-2 rounded font-bold text-red-700 outline-none">
                    </div>
                </div>
                <button onclick="saveStudent()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition">Save Record</button>
            </div>
        </div>
    </div>

    <div id="modal-qr-result" class="fixed inset-0 modal-bg hidden z-[60] flex items-center justify-center fade-in" onclick="if(event.target === this) closeQRModal()">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden m-4 max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-5 flex justify-between items-center text-white sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <i class="fas fa-check-circle text-2xl"></i>
                    <h3 class="font-bold text-lg">Result Verified</h3>
                </div>
                <button onclick="closeQRModal()" class="hover:text-gray-300 text-2xl leading-none">&times;</button>
            </div>
            
            <div class="p-6">
                <div class="text-center mb-6">
                    <p class="text-gray-600">This is an authentic result from</p>
                    <p class="text-xl font-bold text-gray-900" id="qr-modal-institution">Institution Name</p>
                    <p class="text-sm text-gray-500" id="qr-modal-exam-name">Exam Name</p>
                </div>

                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-6 mb-6 border-2 border-gray-200">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-xs text-gray-500 font-bold uppercase mb-1">Student Name</p>
                            <p class="text-xl font-bold text-gray-900" id="qr-modal-name">-</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500 font-bold uppercase mb-1">Roll Number</p>
                            <p class="text-xl font-bold text-indigo-600 font-mono" id="qr-modal-roll">-</p>
                        </div>
                    </div>
                    
                    <div class="border-t-2 border-dashed border-gray-300 pt-4 text-center">
                        <p class="text-xs text-gray-500 font-bold uppercase mb-2">Overall Rank</p>
                        <p class="text-5xl font-bold text-yellow-500" id="qr-modal-rank">#-</p>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-white border-2 border-gray-200 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-500 font-bold uppercase mb-2">Total</p>
                        <p class="text-2xl font-bold text-gray-800" id="qr-modal-total">-</p>
                    </div>
                    <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4 text-center">
                        <p class="text-xs text-green-700 font-bold uppercase mb-2">Correct</p>
                        <p class="text-2xl font-bold text-green-700" id="qr-modal-right">-</p>
                    </div>
                    <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4 text-center">
                        <p class="text-xs text-red-700 font-bold uppercase mb-2">Wrong</p>
                        <p class="text-2xl font-bold text-red-700" id="qr-modal-wrong">-</p>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-indigo-50 to-purple-50 border-2 border-indigo-300 rounded-xl p-6 text-center mb-6">
                    <p class="text-sm text-gray-600 font-bold uppercase mb-2">Total Marks Obtained</p>
                    <p class="text-5xl font-bold text-indigo-600 mb-4" id="qr-modal-marks">-</p>
                    
                    <p class="text-sm text-gray-600 font-bold uppercase mb-2">Percentage</p>
                    <p class="text-4xl font-bold text-purple-600 mb-4" id="qr-modal-percent">-%</p>
                    
                    <div id="qr-modal-badge" class="inline-block px-8 py-3 rounded-full text-lg font-bold uppercase bg-gray-200 text-gray-600">
                        Status
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-xs text-blue-800 text-center">
                        <i class="fas fa-shield-alt mr-1"></i>
                        Verification Code: <span id="qr-modal-code" class="font-mono font-bold">-</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            adminPass: "Rajganj@020240",
            marking: { pos: 4, neg: 1 },
            institution: "Gurukul Public School",
            examName: "Number System and Series Summation"
        };

        let students = JSON.parse(localStorage.getItem('exam_data')) || [];
        let currentViewStudent = null;

        window.onload = () => {
            recalculateRanks();
            loadExamConfig();
            
            const urlParams = new URLSearchParams(window.location.search);
            const vdata = urlParams.get('vdata');
            const directRoll = urlParams.get('roll');
            
            if (vdata) {
                handleQRDataVerification(vdata);
            } else if (directRoll) {
                handleDirectLink(directRoll);
            }
        };

        function handleQRDataVerification(base64Data) {
            try {
                const dataString = decodeURIComponent(escape(atob(base64Data)));
                const data = JSON.parse(dataString);
                
                const hoursPassed = (Date.now() - data.ts) / (1000 * 60 * 60);
                
                if (hoursPassed > 24) {
                    notif('QR code expired (24 hours). Please generate a new result card.', 'error');
                    return;
                }
                
                const fullData = {
                    code: data.c,
                    roll: data.r,
                    name: data.n,
                    marks: data.m,
                    percent: data.p,
                    rank: data.rk,
                    total: data.t,
                    right: data.rt,
                    wrong: data.w,
                    examName: data.en,
                    examSubject: data.es,
                    institution: data.i,
                    passPercent: data.pp
                };
                
                showQRResultModal(fullData);
                window.history.replaceState({}, document.title, window.location.pathname);
                
            } catch (error) {
                console.error('QR decode error:', error);
                notif('Invalid QR code format', 'error');
            }
        }

        function showQRResultModal(data) {
            document.getElementById('qr-modal-institution').innerText = data.institution || CONFIG.institution;
            document.getElementById('qr-modal-exam-name').innerText = data.examName || CONFIG.examName;
            document.getElementById('qr-modal-name').innerText = data.name;
            document.getElementById('qr-modal-roll').innerText = data.roll;
            document.getElementById('qr-modal-rank').innerText = '#' + data.rank;
            document.getElementById('qr-modal-total').innerText = data.total;
            document.getElementById('qr-modal-right').innerText = data.right;
            document.getElementById('qr-modal-wrong').innerText = data.wrong;
            document.getElementById('qr-modal-marks').innerText = data.marks;
            document.getElementById('qr-modal-percent').innerText = data.percent + '%';
            document.getElementById('qr-modal-code').innerText = data.code;
            
            const badge = document.getElementById('qr-modal-badge');
            const passPercentage = data.passPercent || 35;
            const isPassed = parseFloat(data.percent) >= passPercentage;
            badge.innerText = isPassed ? "‚úì PASSED" : "‚úó FAILED";
            badge.className = isPassed 
                ? "inline-block px-8 py-3 rounded-full text-lg font-bold uppercase bg-green-500 text-white"
                : "inline-block px-8 py-3 rounded-full text-lg font-bold uppercase bg-red-500 text-white";
            
            document.getElementById('modal-qr-result').classList.remove('hidden');
        }

        function closeQRModal() {
            document.getElementById('modal-qr-result').classList.add('hidden');
        }

        function handleDirectLink(roll) {
            document.getElementById('search-input').value = roll;
            findStudent();
        }

        function loadExamConfig() {
            document.getElementById('nav-title').innerText = CONFIG.institution;
            document.getElementById('exam-title-display').innerText = CONFIG.examName;
        }

        function recalculateRanks() {
            students = students.map(s => {
                const marks = (s.right * CONFIG.marking.pos) - (s.wrong * CONFIG.marking.neg);
                const maxMarks = s.total * CONFIG.marking.pos;
                const percent = ((marks / maxMarks) * 100).toFixed(2);
                return { ...s, marks, percent };
            });

            students.sort((a, b) => b.marks - a.marks);
            students.forEach((s, i) => s.rank = i + 1);

            localStorage.setItem('exam_data', JSON.stringify(students));
            renderAdminTable();
            if (document.getElementById('total-count')) {
                document.getElementById('total-count').innerText = students.length;
            }
        }

        function switchView(viewName) {
            ['view-student', 'view-login', 'view-dashboard'].forEach(id => 
                document.getElementById(id).classList.add('hidden'));
            
            if(viewName === 'student') {
                document.getElementById('view-student').classList.remove('hidden');
                document.getElementById('result-display').classList.add('hidden');
                document.getElementById('search-input').value = '';
            }
            if(viewName === 'login') document.getElementById('view-login').classList.remove('hidden');
            if(viewName === 'dashboard') document.getElementById('view-dashboard').classList.remove('hidden');
        }

        function notif(msg, type = 'info') {
            const t = document.getElementById('toast');
            const icon = document.querySelector('#toast i');
            
            icon.className = type === 'success' ? 'fas fa-check-circle text-green-400' : 
                             type === 'error' ? 'fas fa-exclamation-circle text-red-400' : 
                             'fas fa-info-circle text-indigo-400';
            
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 3000);
        }

        function findStudent() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            
            if(!query) {
                notif('Please enter a roll number or name', 'error');
                return;
            }

            const s = students.find(st => 
                st.roll.toString().toLowerCase() === query || 
                st.name.toLowerCase().includes(query)
            );
            
            if(s) {
                currentViewStudent = s;
                document.getElementById('search-error').classList.add('hidden');
                document.getElementById('result-display').classList.remove('hidden');
                
                const attempted = s.right + s.wrong;
                
                document.getElementById('disp-name').innerText = s.name;
                document.getElementById('disp-roll').innerText = s.roll;
                document.getElementById('disp-rank').innerText = "#" + s.rank;
                document.getElementById('disp-total').innerText = s.total;
                document.getElementById('disp-attempted').innerText = attempted;
                document.getElementById('disp-right').innerText = s.right;
                document.getElementById('disp-wrong').innerText = s.wrong;
                document.getElementById('disp-marks').innerText = s.marks;
                document.getElementById('disp-percent').innerText = s.percent + "%";
                
                const badge = document.getElementById('disp-badge');
                const isPassed = parseFloat(s.percent) >= 35;
                badge.innerText = isPassed ? "PASSED" : "FAILED";
                badge.className = isPassed 
                    ? "px-3 py-1 rounded-full text-sm font-bold uppercase bg-green-100 text-green-700"
                    : "px-3 py-1 rounded-full text-sm font-bold uppercase bg-red-100 text-red-700";
            } else {
                document.getElementById('result-display').classList.add('hidden');
                document.getElementById('search-error').classList.remove('hidden');
            }
        }

        function shareResultWhatsApp() {
            if(!currentViewStudent) return;
            const s = currentViewStudent;
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?roll=${s.roll}`;
            
            const message = `üèÜ Exam Result Update

Name: ${s.name}
Roll No: ${s.roll}
Rank: #${s.rank}

‚úÖ Score: ${s.marks} (${s.percent}%)

Check full details on the portal!
${shareUrl}`;

            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        async function generateResultJPG(source) {
            const student = source === 'student' ? currentViewStudent : 
                            source === 'admin' ? students.find(s => s.roll === currentViewStudent?.roll) : null;
            
            if(!student) {
                notif('No student data found', 'error');
                return;
            }

            notif('Generating HD Result Card...', 'info');

            const verificationCode = `VER${student.roll}${Date.now().toString().slice(-6)}`;
            const attempted = student.right + student.wrong;
            const unattempted = student.total - attempted;
            
            const qrVerificationData = {
                c: verificationCode,
                r: student.roll,
                n: student.name,
                m: student.marks,
                p: student.percent,
                rk: student.rank,
                t: student.total,
                rt: student.right,
                w: student.wrong,
                en: CONFIG.examName,
                es: CONFIG.examName,
                i: CONFIG.institution,
                pp: 35,
                ts: Date.now()
            };
            
            const dataString = JSON.stringify(qrVerificationData);
            const base64Data = btoa(unescape(encodeURIComponent(dataString)));
            const baseUrl = window.location.origin + window.location.pathname;
            const qrData = `${baseUrl}?vdata=${base64Data}`;
            
            const html = `
                <div class="result-card-a4">
                    <div class="watermark-bg">${CONFIG.institution}</div>
                    
                    <div style="position: absolute; top: 30px; right: 30px; z-index: 1000;">
                        <div style="background: white; padding: 15px; border-radius: 15px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); border: 4px solid #4f46e5;">
                            <div id="qr-container-${student.roll}" style="margin-bottom: 10px; background: white; padding: 8px; border-radius: 8px;"></div>
                            <div style="text-align: center; background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; padding: 8px 12px; border-radius: 8px; font-size: 10px; font-weight: bold; letter-spacing: 0.5px;">
                                üì± SCAN TO VERIFY
                            </div>
                            <div style="text-align: center; margin-top: 8px; font-size: 8px; color: #111827; font-family: monospace; font-weight: bold; background: #f3f4f6; padding: 4px; border-radius: 4px;">
                                ${verificationCode}
                            </div>
                            <div style="text-align: center; margin-top: 6px; font-size: 7px; color: #6b7280; line-height: 1.3;">
                                Works on any device<br>No app needed
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); padding: 45px 40px; padding-right: 220px; text-align: center; color: white; position: relative;">
                        <div style="position: absolute; top: 15px; left: 30px; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 11px; font-weight: bold;">
                            OFFICIAL RESULT CARD
                        </div>
                        <h1 style="font-size: 34px; font-weight: bold; margin: 0 0 12px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">${CONFIG.institution}</h1>
                        <p style="font-size: 19px; margin: 0; opacity: 0.95; font-weight: 600;">${CONFIG.examName}</p>
                    </div>

                    <div style="padding: 35px 40px; padding-bottom: 80px;">
                        <div style="background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); border: 3px solid #e5e7eb; border-radius: 15px; padding: 28px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                                <div>
                                    <p style="font-size: 11px; color: #6b7280; font-weight: bold; text-transform: uppercase; margin: 0 0 8px 0; letter-spacing: 1px;">Student Name</p>
                                    <p style="font-size: 26px; font-weight: bold; color: #111827; margin: 0; line-height: 1.2;">${student.name}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="font-size: 11px; color: #6b7280; font-weight: bold; text-transform: uppercase; margin: 0 0 8px 0; letter-spacing: 1px;">Roll Number</p>
                                    <p style="font-size: 26px; font-weight: bold; color: #4f46e5; margin: 0; font-family: monospace; line-height: 1.2;">${student.roll}</p>
                                </div>
                            </div>
                            <div style="border-top: 3px dashed #d1d5db; padding-top: 25px; text-align: center; position: relative;">
                                <p style="font-size: 13px; color: #6b7280; margin: 0 0 8px 0; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Overall Rank</p>
                                <div style="position: relative; display: inline-block; width: 180px; margin: 0 auto;">
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 180px; height: 70px; background: #fbbf24; opacity: 0.3; border-radius: 35px; z-index: 1;"></div>
                                    <p style="font-size: 52px; font-weight: bold; color: #f59e0b; margin: 0; position: relative; z-index: 2; line-height: 1.3;">#${student.rank}</p>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 25px;">
                            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 18px 12px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.04);">
                                <p style="font-size: 10px; color: #6b7280; font-weight: bold; margin: 0 0 10px 0; text-transform: uppercase;">Total Qs</p>
                                <p style="font-size: 26px; font-weight: bold; color: #111827; margin: 0;">${student.total}</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 18px 12px; text-align: center; box-shadow: 0 2px 6px rgba(59,130,246,0.1);">
                                <p style="font-size: 10px; color: #1d4ed8; font-weight: bold; margin: 0 0 10px 0; text-transform: uppercase;">Attempted</p>
                                <p style="font-size: 26px; font-weight: bold; color: #1d4ed8; margin: 0;">${attempted}</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%); border: 2px solid #22c55e; border-radius: 12px; padding: 18px 12px; text-align: center; box-shadow: 0 2px 6px rgba(34,197,94,0.1);">
                                <p style="font-size: 10px; color: #15803d; font-weight: bold; margin: 0 0 10px 0; text-transform: uppercase;">Correct</p>
                                <p style="font-size: 26px; font-weight: bold; color: #15803d; margin: 0;">${student.right}</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%); border: 2px solid #ef4444; border-radius: 12px; padding: 18px 12px; text-align: center; box-shadow: 0 2px 6px rgba(239,68,68,0.1);">
                                <p style="font-size: 10px; color: #b91c1c; font-weight: bold; margin: 0 0 10px 0; text-transform: uppercase;">Wrong</p>
                                <p style="font-size: 26px; font-weight: bold; color: #b91c1c; margin: 0;">${student.wrong}</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%); border: 2px solid #6366f1; border-radius: 12px; padding: 18px 12px; text-align: center; box-shadow: 0 2px 6px rgba(99,102,241,0.1);">
                                <p style="font-size: 10px; color: #4338ca; font-weight: bold; margin: 0 0 10px 0; text-transform: uppercase;">Marks</p>
                                <p style="font-size: 26px; font-weight: bold; color: #4338ca; margin: 0;">${student.marks}</p>
                            </div>
                        </div>

                        <div style="background: ${parseFloat(student.percent) >= 35 ? 'linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%)' : 'linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%)'}; border: 4px solid ${parseFloat(student.percent) >= 35 ? '#16a34a' : '#dc2626'}; border-radius: 15px; padding: 40px 35px; text-align: center; margin-bottom: 25px; box-shadow: 0 6px 20px ${parseFloat(student.percent) >= 35 ? 'rgba(22,163,74,0.15)' : 'rgba(220,38,38,0.15)'};">
                            <p style="font-size: 15px; color: #374151; font-weight: bold; margin: 0 0 15px 0; text-transform: uppercase; letter-spacing: 1.5px;">Percentage Scored</p>
                            <p style="font-size: 64px; font-weight: bold; color: ${parseFloat(student.percent) >= 35 ? '#16a34a' : '#dc2626'}; margin: 0 0 25px 0; line-height: 1; text-shadow: 0 2px 8px ${parseFloat(student.percent) >= 35 ? 'rgba(22,163,74,0.2)' : 'rgba(220,38,38,0.2)'};">${student.percent}%</p>
                            
                            <div style="border-top: 2px solid ${parseFloat(student.percent) >= 35 ? 'rgba(22,163,74,0.2)' : 'rgba(220,38,38,0.2)'}; padding-top: 25px; margin-top: 5px;">
                                <p style="font-size: 13px; color: #6b7280; font-weight: bold; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 1px;">Final Status</p>
                                <div style="display: inline-block; background: ${parseFloat(student.percent) >= 35 ? '#16a34a' : '#dc2626'}; color: white; padding: 14px 50px; border-radius: 50px; font-size: 22px; font-weight: bold; box-shadow: 0 4px 12px ${parseFloat(student.percent) >= 35 ? 'rgba(22,163,74,0.3)' : 'rgba(220,38,38,0.3)'}; letter-spacing: 1px;">
                                    ${parseFloat(student.percent) >= 35 ? '‚úì PASSED' : '‚úó FAILED'}
                                </div>
                            </div>
                        </div>

                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px 20px; border-radius: 8px; margin-bottom: 25px;">
                            <p style="font-size: 11px; color: #92400e; margin: 0; font-weight: 600;">
                                <strong>Marking Scheme:</strong> Correct: +${CONFIG.marking.pos} | Wrong: -${CONFIG.marking.neg} | Unattempted: ${unattempted} Questions
                            </p>
                        </div>
                    </div>

                    <div style="background: #111827; color: white; padding: 18px 40px; text-align: center; width: 100%; box-sizing: border-box;">
                        <p style="font-size: 11px; margin: 0 0 5px 0; font-weight: 500;">üìÖ Date: ${new Date().toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' })} | Computer-generated result</p>
                        <p style="font-size: 9px; color: #9ca3af; margin: 0;">Powered by ${CONFIG.institution} - ExamPortal Elite | Verify by scanning QR code</p>
                    </div>
                </div>
            `;

            const captureZone = document.getElementById('capture-zone');
            captureZone.innerHTML = html;

            const qrContainer = document.getElementById(`qr-container-${student.roll}`);
            if (!qrContainer) {
                notif('Error generating QR code', 'error');
                return;
            }
            
            qrContainer.innerHTML = '';
            
            try {
                new QRCode(qrContainer, {
                    text: qrData,
                    width: 140,
                    height: 140,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            } catch (error) {
                console.error('QR Code generation error:', error);
                notif('Error generating QR code', 'error');
                return;
            }

            await new Promise(resolve => setTimeout(resolve, 1000));

            html2canvas(captureZone.querySelector('.result-card-a4'), {
                scale: 4,
                useCORS: true,
                backgroundColor: '#ffffff',
                width: 794,
                height: 1123
            }).then(canvas => {
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Result_${student.name.replace(/\s+/g, '_')}_${student.roll}.jpg`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    notif('‚úì Result card downloaded successfully!', 'success');
                    captureZone.innerHTML = '';
                }, 'image/jpeg', 0.98);
            });
        }

        async function generateMeritListJPG() {
            if(students.length === 0) {
                notif('No students found', 'error');
                return;
            }

            notif('Generating Ultra HD Merit List with ALL students...', 'info');

            const topStudents = students;

            const rows = topStudents.map((s, i) => `
                <tr style="border-bottom: 1px solid #e5e7eb; ${i % 2 === 0 ? 'background: #f9fafb;' : 'background: white;'}">
                    <td style="padding: 12px; text-align: center; font-weight: bold; color: ${s.rank <= 3 ? '#fbbf24' : s.rank <= 10 ? '#60a5fa' : '#111827'};">${s.rank}</td>
                    <td style="padding: 12px; font-family: monospace; font-weight: bold;">${s.roll}</td>
                    <td style="padding: 12px; font-weight: 600;">${s.name}</td>
                    <td style="padding: 12px; text-align: center; font-weight: bold; color: #4f46e5;">${s.marks}</td>
                    <td style="padding: 12px; text-align: center; font-weight: bold; color: #16a34a;">${s.percent}%</td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; background: ${parseFloat(s.percent) >= 35 ? '#dcfce7' : '#fee2e2'}; color: ${parseFloat(s.percent) >= 35 ? '#16a34a' : '#dc2626'};">
                            ${parseFloat(s.percent) >= 35 ? 'PASS' : 'FAIL'}
                        </span>
                    </td>
                </tr>
            `).join('');

            const html = `
                <div class="result-card-a4" style="height: auto; min-height: 1123px;">
                    <div class="watermark-bg">MERIT LIST</div>
                    
                    <div style="background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%); padding: 35px; text-align: center; color: white;">
                        <h1 style="font-size: 36px; font-weight: bold; margin: 0 0 10px 0;">üèÜ MERIT LIST üèÜ</h1>
                        <p style="font-size: 20px; margin: 0;">${CONFIG.examName}</p>
                        <p style="font-size: 14px; margin: 8px 0 0 0; opacity: 0.9;">${CONFIG.institution}</p>
                    </div>

                    <div style="padding: 30px; padding-bottom: 100px;">
                        <div style="background: #f9fafb; border-left: 4px solid #4f46e5; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                            <p style="font-size: 14px; color: #374151; margin: 0; font-weight: 600;">
                                <strong>Exam:</strong> ${CONFIG.examName} | 
                                <strong>Total Students:</strong> ${students.length} | 
                                <strong>Showing:</strong> ALL RANKS
                            </p>
                        </div>

                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background: #111827; color: white;">
                                    <th style="padding: 14px; text-align: center; font-size: 12px; text-transform: uppercase;">Rank</th>
                                    <th style="padding: 14px; font-size: 12px; text-transform: uppercase;">Roll</th>
                                    <th style="padding: 14px; font-size: 12px; text-transform: uppercase;">Name</th>
                                    <th style="padding: 14px; text-align: center; font-size: 12px; text-transform: uppercase;">Marks</th>
                                    <th style="padding: 14px; text-align: center; font-size: 12px; text-transform: uppercase;">%</th>
                                    <th style="padding: 14px; text-align: center; font-size: 12px; text-transform: uppercase;">Status</th>
                                </tr>
                            </thead>
                            <tbody style="background: white;">
                                ${rows}
                            </tbody>
                        </table>

                        <div style="margin-top: 30px; padding: 20px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; text-align: center;">
                            <p style="font-size: 12px; color: #92400e; margin: 0; font-weight: bold;">
                                üåü Congratulations to all ${students.length} students! üåü
                            </p>
                        </div>
                    </div>

                    <div style="background: #111827; color: white; padding: 15px 30px; text-align: center; margin-top: 30px;">
                        <p style="font-size: 11px; margin: 0;">Generated: ${new Date().toLocaleString('en-IN')} | ${CONFIG.institution}</p>
                        <p style="font-size: 10px; color: #9ca3af; margin: 5px 0 0 0;">Complete Merit List - All ${students.length} Students Ranked</p>
                    </div>
                </div>
            `;

            const captureZone = document.getElementById('capture-zone');
            captureZone.innerHTML = html;

            await new Promise(resolve => setTimeout(resolve, 300));

            const baseHeight = 400;
            const rowHeight = 45;
            const totalHeight = Math.max(1123, baseHeight + (topStudents.length * rowHeight));

            html2canvas(captureZone.querySelector('.result-card-a4'), {
                scale: 4,
                useCORS: true,
                backgroundColor: '#ffffff',
                width: 794,
                height: totalHeight,
                windowHeight: totalHeight
            }).then(canvas => {
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Merit_List_${CONFIG.examName.replace(/\s+/g, '_')}_ALL_${students.length}_Students.jpg`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    notif(`‚úì Merit list with ${students.length} students downloaded!`, 'success');
                    captureZone.innerHTML = '';
                }, 'image/jpeg', 0.98);
            });
        }

        function handleLogin() {
            const p = document.getElementById('admin-pass').value;
            if(p === CONFIG.adminPass) {
                switchView('dashboard');
                document.getElementById('admin-pass').value = '';
                document.getElementById('login-msg').classList.add('hidden');
            } else {
                document.getElementById('login-msg').classList.remove('hidden');
            }
        }

        function logout() {
            switchView('student');
            notif('Logged out successfully', 'success');
        }

        function renderAdminTable() {
            const tbody = document.getElementById('admin-tbody');
            tbody.innerHTML = students.map(s => {
                const isPassed = parseFloat(s.percent) >= 35;
                return `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="p-4 text-center font-bold ${s.rank <= 3 ? 'text-yellow-500' : 'text-gray-800'}">#${s.rank}</td>
                        <td class="p-4 font-mono font-bold">${s.roll}</td>
                        <td class="p-4 font-semibold">${s.name}</td>
                        <td class="p-4 text-center font-bold text-indigo-600">${s.marks}</td>
                        <td class="p-4 text-center font-bold text-green-600">${s.percent}%</td>
                        <td class="p-4 text-center">
                            <button onclick="editStudent('${s.roll}')" class="text-blue-600 hover:text-blue-800 mx-1" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="viewStudentResult('${s.roll}')" class="text-green-600 hover:text-green-800 mx-1" title="View Result">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="deleteStudent('${s.roll}')" class="text-red-600 hover:text-red-800 mx-1" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewStudentResult(roll) {
            const s = students.find(st => st.roll === roll);
            if(s) {
                currentViewStudent = s;
                generateResultJPG('admin');
            }
        }

        function openModal(type) {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = type === 'add' ? 'Add Student' : 'Edit Student';
            
            if(type === 'add') {
                document.getElementById('edit-roll-ref').value = '';
                document.getElementById('inp-name').value = '';
                document.getElementById('inp-roll').value = '';
                document.getElementById('inp-total').value = 100;
                document.getElementById('inp-right').value = '';
                document.getElementById('inp-wrong').value = '';
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function editStudent(roll) {
            const s = students.find(st => st.roll === roll);
            if(s) {
                openModal('edit');
                document.getElementById('edit-roll-ref').value = s.roll;
                document.getElementById('inp-name').value = s.name;
                document.getElementById('inp-roll').value = s.roll;
                document.getElementById('inp-total').value = s.total;
                document.getElementById('inp-right').value = s.right;
                document.getElementById('inp-wrong').value = s.wrong;
            }
        }

        function saveStudent() {
            const name = document.getElementById('inp-name').value.trim();
            const roll = document.getElementById('inp-roll').value.trim();
            const total = parseInt(document.getElementById('inp-total').value);
            const right = parseInt(document.getElementById('inp-right').value);
            const wrong = parseInt(document.getElementById('inp-wrong').value);

            if(!name || !roll || isNaN(total) || isNaN(right) || isNaN(wrong)) {
                notif('Please fill all fields correctly', 'error');
                return;
            }

            const editRef = document.getElementById('edit-roll-ref').value;
            
            if(editRef) {
                const idx = students.findIndex(s => s.roll === editRef);
                if(idx !== -1) {
                    students[idx] = { roll, name, total, right, wrong };
                    notif('‚úì Student updated successfully', 'success');
                }
            } else {
                if(students.find(s => s.roll === roll)) {
                    notif('Roll number already exists', 'error');
                    return;
                }
                students.push({ roll, name, total, right, wrong });
                notif('‚úì Student added successfully', 'success');
            }

            recalculateRanks();
            closeModal();
        }

        function deleteStudent(roll) {
            if(confirm('Are you sure you want to delete this student?')) {
                students = students.filter(s => s.roll !== roll);
                recalculateRanks();
                notif('‚úì Student deleted', 'success');
            }
        }
    </script>
</body>
</html>

