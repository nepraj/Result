<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResultScope | Result Hosting Platform</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* A4 Paper Simulation */
        .a4-paper {
            width: 794px; /* A4 width at 96dpi */
            min-height: 1123px; /* A4 height */
            background: white;
            margin: 0 auto;
            padding: 40px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: none; /* Hidden by default */
        }

        /* Print Specifics */
        @media print {
            body * { visibility: hidden; }
            #result-container, #result-container * { visibility: visible; }
            #result-container { position: absolute; left: 0; top: 0; }
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ===== THEME SYSTEM ===== */
        :root {
            --primary: #1e3a5f;
            --primary-mid: #1d4ed8;
            --primary-light: #3b82f6;
            --accent: #1e40af;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --nav-text: #ffffff;
            --btn-primary-bg: #1d4ed8;
            --btn-primary-hover: #1e40af;
            --result-header-color: #1e3a5f;
            --result-badge-bg: #dbeafe;
            --result-badge-text: #1e40af;
            --font-body: 'Inter', sans-serif;
            --radius: 0.5rem;
        }

        /* Theme: Royal Purple */
        body.theme-purple { --primary: #3b0764; --primary-mid: #7c3aed; --primary-light: #8b5cf6; --accent: #6d28d9; --bg-body: #f5f3ff; --btn-primary-bg: #7c3aed; --btn-primary-hover: #6d28d9; --result-header-color: #3b0764; --result-badge-bg: #ede9fe; --result-badge-text: #6d28d9; }

        /* Theme: Forest Green */
        body.theme-green { --primary: #14532d; --primary-mid: #16a34a; --primary-light: #22c55e; --accent: #15803d; --bg-body: #f0fdf4; --btn-primary-bg: #16a34a; --btn-primary-hover: #15803d; --result-header-color: #14532d; --result-badge-bg: #dcfce7; --result-badge-text: #15803d; }

        /* Theme: Crimson Red */
        body.theme-red { --primary: #7f1d1d; --primary-mid: #dc2626; --primary-light: #ef4444; --accent: #b91c1c; --bg-body: #fff5f5; --btn-primary-bg: #dc2626; --btn-primary-hover: #b91c1c; --result-header-color: #7f1d1d; --result-badge-bg: #fee2e2; --result-badge-text: #b91c1c; }

        /* Theme: Ocean Teal */
        body.theme-teal { --primary: #134e4a; --primary-mid: #0d9488; --primary-light: #14b8a6; --accent: #0f766e; --bg-body: #f0fdfa; --btn-primary-bg: #0d9488; --btn-primary-hover: #0f766e; --result-header-color: #134e4a; --result-badge-bg: #ccfbf1; --result-badge-text: #0f766e; }

        /* Theme: Midnight Dark */
        body.theme-dark { --primary: #0f172a; --primary-mid: #334155; --primary-light: #64748b; --accent: #475569; --bg-body: #1e293b; --bg-card: #1e293b; --nav-text: #e2e8f0; --btn-primary-bg: #334155; --btn-primary-hover: #475569; --result-header-color: #0f172a; --result-badge-bg: #334155; --result-badge-text: #94a3b8; }
        body.theme-dark .a4-paper { background: #1e293b; color: #e2e8f0; }
        body.theme-dark #search-section, body.theme-dark .bg-white { background-color: #1e293b !important; color: #e2e8f0; }

        /* Theme: Sunset Orange */
        body.theme-orange { --primary: #7c2d12; --primary-mid: #ea580c; --primary-light: #f97316; --accent: #c2410c; --bg-body: #fff7ed; --btn-primary-bg: #ea580c; --btn-primary-hover: #c2410c; --result-header-color: #7c2d12; --result-badge-bg: #ffedd5; --result-badge-text: #c2410c; }

        /* Theme: Rose Gold */
        body.theme-rose { --primary: #881337; --primary-mid: #e11d48; --primary-light: #f43f5e; --accent: #be123c; --bg-body: #fff1f2; --btn-primary-bg: #e11d48; --btn-primary-hover: #be123c; --result-header-color: #881337; --result-badge-bg: #ffe4e6; --result-badge-text: #be123c; }

        /* Theme: Indigo Academic */
        body.theme-indigo { --primary: #312e81; --primary-mid: #4f46e5; --primary-light: #6366f1; --accent: #4338ca; --bg-body: #eef2ff; --btn-primary-bg: #4f46e5; --btn-primary-hover: #4338ca; --result-header-color: #312e81; --result-badge-bg: #e0e7ff; --result-badge-text: #4338ca; }

        /* Apply CSS variables to elements */
        body { background-color: var(--bg-body); }
        nav.app-nav { background-color: var(--primary) !important; }
        .btn-primary-theme { background-color: var(--btn-primary-bg) !important; }
        .btn-primary-theme:hover { background-color: var(--btn-primary-hover) !important; }

        /* Theme card selector styles */
        .theme-card { cursor: pointer; border: 3px solid transparent; border-radius: 10px; padding: 10px; text-align:center; transition: all 0.2s; }
        .theme-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .theme-card.selected { border-color: #000; box-shadow: 0 0 0 3px rgba(0,0,0,0.2); }
        .theme-swatch { width:100%; height:40px; border-radius:6px; margin-bottom:6px; }

        /* Subject builder table */
        .subject-row .subject-row-input { width:80px; border:1px solid #d1d5db; border-radius:4px; padding:4px 6px; text-align:center; }
        .subject-row .subject-row-input:focus { outline: 2px solid var(--primary-light); }
    </style>
</head>
<body class="text-gray-800">

    <nav class="bg-blue-900 text-white shadow-lg relative z-20 app-nav">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-graduation-cap text-2xl"></i>
                <span id="nav-inst-name" class="text-xl font-bold tracking-wide">ResultScope</span>
            </div>
            <div>
                <button onclick="toggleAdminPanel()" class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded text-sm font-semibold transition">
                    <i class="fas fa-user-shield mr-2"></i>Admin Login
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8 relative z-10">

        <section id="search-section" class="max-w-xl mx-auto bg-white rounded-lg shadow-md p-8 mb-8 text-center">
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Check Result</h2>
            <p class="text-gray-500 mb-6">Enter your details to view your scorecard.</p>
            
            <div class="space-y-4">
                <input type="text" id="search-roll" placeholder="Enter Roll Number (any format)" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button onclick="searchResult()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition transform hover:scale-[1.02]">
                    View Result
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-4">Demo Roll Nos: 1001 (Academic), 2001 (Competition)</p>
        </section>

        <!-- Result Paused Message -->
        <section id="result-paused-section" class="hidden max-w-xl mx-auto bg-yellow-50 border-2 border-yellow-300 rounded-lg shadow-md p-8 mb-8 text-center">
            <div class="mb-4">
                <i class="fas fa-clock text-6xl text-yellow-500"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2 text-yellow-800">Result Coming Soon</h2>
            <p class="text-gray-700 mb-2">The result for Roll Number <span id="paused-roll" class="font-bold"></span> is being prepared.</p>
            <p class="text-gray-500 text-sm mb-6">Please check back later. Your result will be published shortly.</p>
            <button onclick="backToSearch()" class="bg-yellow-600 text-white px-6 py-2 rounded-lg hover:bg-yellow-700 transition">
                <i class="fas fa-arrow-left mr-2"></i>Back to Search
            </button>
        </section>

        <div id="admin-return-wrapper" class="hidden max-w-[794px] mx-auto mb-4">
            <button onclick="returnToAdminDashboard()" class="bg-gray-800 text-white px-4 py-2 rounded shadow hover:bg-gray-700 font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
            </button>
        </div>

        <div id="result-wrapper" class="hidden flex flex-col items-center">
            
            <div class="flex space-x-4 mb-6">
                <button id="student-back-btn" onclick="resetSearch()" class="bg-gray-500 text-white px-6 py-2 rounded shadow hover:bg-gray-600 font-semibold">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Search
                </button>
                <button onclick="downloadJPG()" class="bg-green-600 text-white px-6 py-2 rounded shadow hover:bg-green-700 font-semibold">
                    <i class="fas fa-download mr-2"></i>Download HD JPG
                </button>
                <button onclick="shareResult()" class="bg-indigo-600 text-white px-6 py-2 rounded shadow hover:bg-indigo-700 font-semibold">
                    <i class="fas fa-share-alt mr-2"></i>Share
                </button>
            </div>

            <div id="result-container" class="a4-paper relative">
                <div class="border-b-4 border-blue-900 pb-4 mb-6 text-center">
                    <h1 id="res-inst-name" class="text-4xl font-bold text-blue-900 uppercase mb-2">Institution Name</h1>
                    <p id="res-inst-address" class="text-gray-600">Address Line 1, City, State - Zip Code</p>
                    <div class="mt-4 bg-blue-100 text-blue-900 inline-block px-4 py-1 rounded-full text-sm font-bold uppercase tracking-wider" id="res-exam-name">Annual Examination 2024</div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-8 text-sm border p-4 rounded bg-gray-50">
                    <div><span class="font-bold text-gray-500">Name:</span> <span id="res-name" class="text-lg font-semibold block">Student Name</span></div>
                    <div><span class="font-bold text-gray-500">Roll Number:</span> <span id="res-roll" class="text-lg font-semibold block">00000</span></div>
                    
                    <div id="wrapper-father"><span class="font-bold text-gray-500">Father's Name:</span> <span id="res-father" class="block">Parent Name</span></div>
                    <div id="wrapper-dob"><span class="font-bold text-gray-500">Date of Birth:</span> <span id="res-dob" class="block">01-01-2000</span></div>
                </div>

                <div id="dynamic-result-content" class="mb-8">
                    </div>

                <div class="absolute bottom-10 left-10 right-10 flex justify-between items-end border-t pt-4">
                    <div class="text-center">
                        <div id="qrcode" class="mb-2"></div>
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest">Scan to Validate</p>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <div class="h-16 w-32 mb-2 flex items-end justify-end">
                            <img id="res-sig-img" src="" class="max-h-full max-w-full object-contain hidden" alt="Signature">
                            <div id="res-sig-line" class="w-full border-b border-gray-400"></div>
                        </div>
                        <p id="res-controller-label" class="font-bold text-blue-900 hidden">Controller of Examinations</p>
                        <p class="text-xs text-gray-500" id="res-date">Date: 12-10-2024</p>
                    </div>
                </div>

                <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-[0.03]">
                    <i class="fas fa-university text-[400px]"></i>
                </div>
            </div>
        </div>

    </main>

    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-0 md:p-4">
        <div class="bg-white md:rounded-lg shadow-2xl w-full h-full md:h-auto md:max-w-6xl overflow-hidden flex flex-col">
            
            <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-cog mr-2"></i>Admin Dashboard</h3>
                <div class="flex items-center gap-3">
                    <div class="text-xs font-mono bg-gray-700 px-2 py-1 rounded text-green-400" id="session-timer">
                        Session: 30:00
                    </div>
                    <button onclick="adminLogout()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm font-semibold transition">
                        <i class="fas fa-sign-out-alt mr-1"></i>Logout
                    </button>
                </div>
                <button onclick="toggleAdminPanel()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>

            <div id="admin-login-view" class="p-8 text-center">
                <h4 class="text-xl font-bold mb-4">Secure Login</h4>
                <input type="password" id="admin-pass" placeholder="Password" class="border p-2 rounded w-64 mb-4 block mx-auto">
                <div class="flex justify-center gap-3">
                    <button onclick="toggleAdminPanel()" class="bg-gray-500 text-white px-6 py-2 rounded font-bold hover:bg-gray-600 transition">Back to Home</button>
                    <button onclick="adminLogin()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700 transition">Login</button>
                </div>
            </div>

            <div id="admin-dashboard-view" class="hidden">
                <div class="flex border-b overflow-x-auto">
                    <button onclick="switchTab('upload')" class="flex-1 p-3 text-sm font-bold bg-gray-100 hover:bg-gray-200 whitespace-nowrap" id="tab-btn-upload">Add Result</button>
                    <button onclick="switchTab('view')" class="flex-1 p-3 text-sm font-bold hover:bg-gray-200 whitespace-nowrap" id="tab-btn-view">View Results</button>
                    <button onclick="switchTab('exams')" class="flex-1 p-3 text-sm font-bold hover:bg-gray-200 whitespace-nowrap" id="tab-btn-exams">Manage Exams</button>
                    <button onclick="switchTab('institutions')" class="flex-1 p-3 text-sm font-bold hover:bg-gray-200 whitespace-nowrap" id="tab-btn-institutions">Institutions</button>
                    <button onclick="switchTab('settings')" class="flex-1 p-3 text-sm font-bold hover:bg-gray-200 whitespace-nowrap" id="tab-btn-settings">Settings</button>
                </div>

                <div class="p-6 overflow-y-auto flex-1 max-h-[calc(100vh-60px)] md:max-h-[80vh]">
                    
                    <div id="tab-upload">
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">Result Type</label>
                            <select id="new-type" onchange="toggleFormType()" class="w-full border p-2 rounded">
                                <option value="academic">Academic (Subjects & Grades)</option>
                                <option value="competition">Competition (Marks & Negatives)</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <input type="text" id="new-name" placeholder="Student Name" class="border p-2 rounded">
                            <input type="text" id="new-roll" placeholder="Roll Number" class="border p-2 rounded">
                            
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Select Exam</label>
                                <select id="new-exam" class="w-full border p-2 rounded">
                                    <option value="">-- Select Exam --</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Select Institution</label>
                                <select id="new-institution" class="w-full border p-2 rounded">
                                    <option value="">-- Select Institution --</option>
                                </select>
                            </div>
                            
                            <input type="text" id="new-father" placeholder="Father's Name (Optional)" class="border p-2 rounded">
                            <input type="text" id="new-dob" placeholder="DOB (Optional: YYYY-MM-DD)" class="border p-2 rounded">
                        </div>

                        <div id="form-academic" class="space-y-3">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold text-gray-500 uppercase">Add Subjects</span>
                            </div>
                            <!-- Subject Picker Row -->
                            <div class="flex items-center gap-2">
                                <select id="subject-picker" class="flex-1 border p-2 rounded text-sm">
                                    <option value="">-- Select Subject --</option>
                                </select>
                                <input type="number" id="subject-fullmarks" placeholder="Full Marks" value="100" min="1" class="w-24 border p-2 rounded text-sm">
                                <button type="button" onclick="addSubjectRow()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-blue-700">+ Add</button>
                            </div>
                            <!-- Custom Subject Entry -->
                            <div class="flex items-center gap-2 bg-gray-50 p-2 rounded border text-xs">
                                <span class="text-gray-500 whitespace-nowrap">New subject:</span>
                                <input type="text" id="custom-subject-name" placeholder="Type custom subject name" class="flex-1 border p-1 rounded">
                                <button type="button" onclick="saveCustomSubject()" class="bg-gray-600 text-white px-2 py-1 rounded whitespace-nowrap">Save to List</button>
                            </div>
                            <!-- Subjects Table -->
                            <div id="subjects-table-container" class="hidden">
                                <table class="w-full text-sm border-collapse border border-gray-200 rounded overflow-hidden">
                                    <thead class="bg-gray-100 text-xs uppercase text-gray-600">
                                        <tr>
                                            <th class="p-2 text-left">Subject</th>
                                            <th class="p-2 text-center">Marks Obtained</th>
                                            <th class="p-2 text-center">Full Marks</th>
                                            <th class="p-2 text-center">%</th>
                                            <th class="p-2"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="subjects-rows"></tbody>
                                    <tfoot class="bg-blue-50 font-bold text-sm">
                                        <tr>
                                            <td class="p-2">Total</td>
                                            <td class="p-2 text-center" id="total-obtained">—</td>
                                            <td class="p-2 text-center" id="total-fullmarks">—</td>
                                            <td class="p-2 text-center text-blue-700" id="total-percent">—</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <div id="form-competition" class="hidden grid grid-cols-2 gap-2">
                            <input type="number" id="new-total-q" placeholder="Total Questions" class="border p-2 rounded">
                            <input type="number" id="new-correct" placeholder="Correct Answers" class="border p-2 rounded">
                            <input type="number" id="new-incorrect" placeholder="Incorrect Answers" class="border p-2 rounded">
                            <input type="number" id="new-pos-mark" placeholder="Marks per Correct" value="4" class="border p-2 rounded">
                            <input type="number" id="new-neg-mark" placeholder="Negative Marking" value="1" class="border p-2 rounded">
                        </div>

                        <!-- Status Toggle -->
                        <div class="mt-4 flex items-center gap-3 p-3 bg-gray-50 border rounded">
                            <span class="text-sm font-bold text-gray-600 whitespace-nowrap">Result Status:</span>
                            <div class="flex gap-3 flex-1">
                                <label class="flex items-center gap-2 cursor-pointer flex-1 p-2 rounded border-2 border-green-400 bg-green-50 hover:bg-green-100 transition">
                                    <input type="radio" name="new-status" id="new-status-live" value="live" checked class="accent-green-600">
                                    <span class="text-sm font-semibold text-green-800"><i class="fas fa-circle text-green-500 text-xs mr-1"></i>Live (Visible)</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer flex-1 p-2 rounded border-2 border-yellow-400 bg-yellow-50 hover:bg-yellow-100 transition">
                                    <input type="radio" name="new-status" id="new-status-paused" value="paused" class="accent-yellow-600">
                                    <span class="text-sm font-semibold text-yellow-800"><i class="fas fa-pause-circle text-yellow-500 text-xs mr-1"></i>Paused (Hidden)</span>
                                </label>
                            </div>
                        </div>
                        <button onclick="saveResult()" class="w-full bg-green-600 text-white font-bold py-2 rounded mt-3">Save Result</button>
                    </div>

                    <!-- EDIT RESULT TAB -->
                    <div id="tab-edit" class="hidden">
                        <div class="mb-4 flex items-center justify-between">
                            <h3 class="font-bold text-lg">Edit Result</h3>
                            <button onclick="cancelEdit()" class="text-gray-600 hover:text-gray-800 text-sm">
                                <i class="fas fa-times mr-1"></i>Cancel
                            </button>
                        </div>
                        
                        <input type="hidden" id="edit-original-roll">
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">Result Type</label>
                            <select id="edit-type" onchange="toggleEditFormType()" class="w-full border p-2 rounded">
                                <option value="academic">Academic (Subjects & Grades)</option>
                                <option value="competition">Competition (Marks & Negatives)</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <input type="text" id="edit-name" placeholder="Student Name" class="border p-2 rounded">
                            <input type="text" id="edit-roll" placeholder="Roll Number" class="border p-2 rounded">
                            
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Select Exam</label>
                                <select id="edit-exam" class="w-full border p-2 rounded">
                                    <option value="">-- Select Exam --</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Select Institution</label>
                                <select id="edit-institution" class="w-full border p-2 rounded">
                                    <option value="">-- Select Institution --</option>
                                </select>
                            </div>
                            
                            <input type="text" id="edit-father" placeholder="Father's Name (Optional)" class="border p-2 rounded">
                            <input type="text" id="edit-dob" placeholder="DOB (Optional: YYYY-MM-DD)" class="border p-2 rounded">
                        </div>

                        <div id="edit-form-academic" class="space-y-3">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold text-gray-500 uppercase">Edit Subjects</span>
                            </div>
                            <!-- Subject Picker Row -->
                            <div class="flex items-center gap-2">
                                <select id="edit-subject-picker" class="flex-1 border p-2 rounded text-sm">
                                    <option value="">-- Select Subject --</option>
                                </select>
                                <input type="number" id="edit-subject-fullmarks" placeholder="Full Marks" value="100" min="1" class="w-24 border p-2 rounded text-sm">
                                <button type="button" onclick="addEditSubjectRow()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-blue-700">+ Add</button>
                            </div>
                            <!-- Custom Subject Entry -->
                            <div class="flex items-center gap-2 bg-gray-50 p-2 rounded border text-xs">
                                <span class="text-gray-500 whitespace-nowrap">New subject:</span>
                                <input type="text" id="edit-custom-subject-name" placeholder="Type custom subject name" class="flex-1 border p-1 rounded">
                                <button type="button" onclick="saveEditCustomSubject()" class="bg-gray-600 text-white px-2 py-1 rounded whitespace-nowrap">Save to List</button>
                            </div>
                            <!-- Subjects Table -->
                            <div id="edit-subjects-table-container" class="hidden">
                                <table class="w-full text-sm border-collapse border border-gray-200 rounded overflow-hidden">
                                    <thead class="bg-gray-100 text-xs uppercase text-gray-600">
                                        <tr>
                                            <th class="p-2 text-left">Subject</th>
                                            <th class="p-2 text-center">Marks Obtained</th>
                                            <th class="p-2 text-center">Full Marks</th>
                                            <th class="p-2 text-center">%</th>
                                            <th class="p-2"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="edit-subjects-rows"></tbody>
                                    <tfoot class="bg-blue-50 font-bold text-sm">
                                        <tr>
                                            <td class="p-2">Total</td>
                                            <td class="p-2 text-center" id="edit-total-obtained">—</td>
                                            <td class="p-2 text-center" id="edit-total-fullmarks">—</td>
                                            <td class="p-2 text-center text-blue-700" id="edit-total-percent">—</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <div id="edit-form-competition" class="hidden grid grid-cols-2 gap-2">
                            <input type="number" id="edit-total-q" placeholder="Total Questions" class="border p-2 rounded">
                            <input type="number" id="edit-correct" placeholder="Correct Answers" class="border p-2 rounded">
                            <input type="number" id="edit-incorrect" placeholder="Incorrect Answers" class="border p-2 rounded">
                            <input type="number" id="edit-pos-mark" placeholder="Marks per Correct" value="4" class="border p-2 rounded">
                            <input type="number" id="edit-neg-mark" placeholder="Negative Marking" value="1" class="border p-2 rounded">
                        </div>

                        <button onclick="updateResult()" class="w-full bg-blue-600 text-white font-bold py-2 rounded mt-4">Update Result</button>
                        
                        <!-- Status & Delete in Edit Form -->
                        <div class="mt-3 flex gap-2">
                            <button onclick="toggleStatusFromEdit()" id="edit-status-toggle-btn" class="flex-1 py-2 rounded font-bold text-sm text-white transition">
                                <i class="fas fa-pause-circle mr-1"></i> <span id="edit-status-toggle-label">Pause Result</span>
                            </button>
                            <button onclick="deleteResultFromEdit()" class="flex-1 bg-red-600 text-white font-bold py-2 rounded hover:bg-red-700 transition text-sm">
                                <i class="fas fa-trash mr-1"></i>Delete Result
                            </button>
                            </div>
                    </div>

                    <div id="tab-view" class="hidden">
                        <!-- Global Status Control -->
                        <div id="global-status-bar" class="mb-3 p-3 rounded border flex items-center justify-between">
                            <div>
                                <span class="font-bold text-sm" id="global-status-label">All Results: LIVE</span>
                                <p class="text-xs text-gray-500 mt-0.5" id="global-status-desc">Students can view their results normally.</p>
                            </div>
                            <button onclick="toggleGlobalStatus()" id="global-status-btn" class="px-4 py-2 rounded font-bold text-sm text-white transition">
                                Pause All
                            </button>
                        </div>
                        <div class="mb-3 p-2 bg-blue-50 text-blue-800 text-xs border border-blue-100 rounded">
                            <i class="fas fa-info-circle mr-1"></i> Click "View" to see the result card. Use the back button on top to return here.
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 border rounded">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3">Roll</th>
                                        <th class="px-4 py-3">Name</th>
                                        <th class="px-4 py-3">Type</th>
                                        <th class="px-4 py-3">Status</th>
                                        <th class="px-4 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-results-list">
                                    </tbody>
                            </table>
                        </div>
                        <p id="no-results-msg" class="text-center text-gray-400 py-4 hidden">No results found.</p>
                    </div>

                    <!-- EXAMS TAB -->
                    <div id="tab-exams" class="hidden">
                        <h3 class="font-bold text-lg mb-4">Manage Exams</h3>
                        
                        <div class="bg-gray-50 p-4 rounded border mb-4">
                            <h4 class="font-bold mb-3">Add New Exam</h4>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <input type="text" id="exam-name" placeholder="Exam Name (e.g., Annual Exam 2024)" class="border p-2 rounded">
                                <input type="number" id="exam-total-marks" placeholder="Total Marks" class="border p-2 rounded">
                                <input type="number" id="exam-total-questions" placeholder="Total Questions" class="border p-2 rounded">
                                <input type="number" id="exam-correct-marks" placeholder="Marks per Correct Answer" class="border p-2 rounded">
                                <input type="number" id="exam-wrong-marks" placeholder="Negative Marks per Wrong" class="border p-2 rounded">
                            </div>
                            <button onclick="addExam()" class="w-full bg-blue-600 text-white font-bold py-2 rounded mt-2">Add Exam</button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 border rounded">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3">Exam Name</th>
                                        <th class="px-4 py-3">Total Marks</th>
                                        <th class="px-4 py-3">Questions</th>
                                        <th class="px-4 py-3">+ve Marks</th>
                                        <th class="px-4 py-3">-ve Marks</th>
                                        <th class="px-4 py-3 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="exams-list">
                                </tbody>
                            </table>
                        </div>
                        <p id="no-exams-msg" class="text-center text-gray-400 py-4 hidden">No exams added yet.</p>
                    </div>

                    <!-- INSTITUTIONS TAB -->
                    <div id="tab-institutions" class="hidden">
                        <h3 class="font-bold text-lg mb-4">Manage Institutions</h3>
                        
                        <div class="bg-gray-50 p-4 rounded border mb-4">
                            <h4 class="font-bold mb-3">Add New Institution</h4>
                            <input type="text" id="inst-name" placeholder="Institution Name" class="w-full border p-2 rounded mb-2">
                            <textarea id="inst-address" placeholder="Institution Address" rows="2" class="w-full border p-2 rounded mb-2"></textarea>
                            <button onclick="addInstitution()" class="w-full bg-blue-600 text-white font-bold py-2 rounded">Add Institution</button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 border rounded">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3">Institution Name</th>
                                        <th class="px-4 py-3">Address</th>
                                        <th class="px-4 py-3 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="institutions-list">
                                </tbody>
                            </table>
                        </div>
                        <p id="no-institutions-msg" class="text-center text-gray-400 py-4 hidden">No institutions added yet.</p>
                    </div>

                    <div id="tab-settings" class="hidden space-y-6">
                        <!-- Institution Details -->
                        <div class="bg-gray-50 p-4 rounded border">
                            <h4 class="font-bold text-sm mb-3 text-gray-700 uppercase tracking-wide"><i class="fas fa-university mr-2 text-blue-600"></i>Institution Details</h4>
                            <input type="text" id="set-inst-name" placeholder="Institution Name" class="w-full border p-2 rounded mb-2">
                            <input type="text" id="set-inst-addr" placeholder="Address" class="w-full border p-2 rounded mb-3">
                            
                            <label class="block text-xs font-bold text-gray-500 mb-1">Controller Signature (Optional)</label>
                            <div class="flex items-center gap-4 mb-3">
                                <div class="flex-1">
                                    <input type="file" id="set-sig-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <p class="text-[10px] text-gray-400 mt-1">Upload PNG/JPG (Transparent background recommended)</p>
                                </div>
                                <div class="h-12 w-24 border bg-gray-50 flex items-center justify-center overflow-hidden">
                                    <img id="set-sig-preview" src="" class="max-h-full max-w-full object-contain hidden">
                                    <span id="set-sig-placeholder" class="text-xs text-gray-300">No Sig</span>
                                </div>
                                <button onclick="clearSignature()" class="text-red-500 text-xs hover:underline">Remove</button>
                            </div>
                            <button onclick="saveSettings()" class="bg-blue-600 text-white px-4 py-2 rounded w-full font-bold">Update Settings</button>
                        </div>

                        <!-- Subject Master List -->
                        <div class="bg-gray-50 p-4 rounded border">
                            <h4 class="font-bold text-sm mb-3 text-gray-700 uppercase tracking-wide"><i class="fas fa-book mr-2 text-green-600"></i>Manage Subject List</h4>
                            <p class="text-xs text-gray-500 mb-3">These subjects will appear in the dropdown when adding academic results.</p>
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="manage-subject-input" placeholder="e.g. Mathematics, Physics, History..." class="flex-1 border p-2 rounded text-sm">
                                <button onclick="addManagedSubject()" class="bg-green-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-green-700">Add</button>
                            </div>
                            <div id="managed-subjects-list" class="flex flex-wrap gap-2 min-h-[40px]">
                                <!-- Tags rendered here -->
                            </div>
                        </div>

                        <!-- Themes -->
                        <div class="bg-gray-50 p-4 rounded border">
                            <h4 class="font-bold text-sm mb-1 text-gray-700 uppercase tracking-wide"><i class="fas fa-palette mr-2 text-purple-600"></i>Theme</h4>
                            <p class="text-xs text-gray-500 mb-4">Choose a visual theme for the entire platform. Applied instantly.</p>
                            <div class="grid grid-cols-3 gap-3" id="theme-grid">

                                <div class="theme-card" data-theme="" onclick="selectTheme(this)">
                                    <div class="theme-swatch" style="background:linear-gradient(135deg,#1e3a5f 50%,#3b82f6 100%)"></div>
                                    <p class="text-xs font-semibold text-gray-700">Classic Blue</p>
                                    <p class="text-[10px] text-gray-400">Default</p>
                                </div>

                                <div class="theme-card" data-theme="theme-purple" onclick="selectTheme(this)">
                                    <div class="theme-swatch" style="background:linear-gradient(135deg,#3b0764 50%,#8b5cf6 100%)"></div>
                                    <p class="text-xs font-semibold text-gray-700">Royal Purple</p>
                                    <p class="text-[10px] text-gray-400">Elegant</p>
                                </div>

                                <div class="theme-card" data-theme="theme-green" onclick="selectTheme(this)">
                                    <div class="theme-swatch" style="background:linear-gradient(135deg,#14532d 50%,#22c55e 100%)"></div>
                                    <p class="text-xs font-semibold text-gray-700">Forest Green</p>
                                    <p class="text-[10px] text-gray-400">Nature</p>
                                </div>

                                <div class="theme-card" data-theme="theme-red" onclick="selectTheme(this)">
                                    <div class="theme-swatch" style="background:linear-gradient(135deg,#7f1d1d 50%,#ef4444 100%)"></div>
                                    <p class="text-xs font-semibold text-gray-700">Crimson Red</p>
                                    <p class="text-[10px] text-gray-400">Bold</p>
                                </div>

                                <div class="theme-card" data-theme="theme-teal" onclick="selectTheme(this)">
                                    <div class="theme-swatch" style="background:linear-gradient(135deg,#134e4a 50%,#14b8a6 100%)"></div>
                                    <p class="text-xs font-semibold text-gray-700">Ocean Teal</p>
                                    <p class="text-[10px] text-gray-400">Calm</p>
                                </div>

                                <div class="theme-card" data-theme="theme-dark" onclick="selectTheme(this)">
                                    <div class="theme-swatch" style="background:linear-gradient(135deg,#0f172a 50%,#334155 100%)"></div>
                                    <p class="text-xs font-semibold text-gray-700">Midnight Dark</p>
                                    <p class="text-[10px] text-gray-400">Dark Mode</p>
                                </div>

                                <div class="theme-card" data-theme="theme-orange" onclick="selectTheme(this)">
                                    <div class="theme-swatch" style="background:linear-gradient(135deg,#7c2d12 50%,#f97316 100%)"></div>
                                    <p class="text-xs font-semibold text-gray-700">Sunset Orange</p>
                                    <p class="text-[10px] text-gray-400">Warm</p>
                                </div>

                                <div class="theme-card" data-theme="theme-rose" onclick="selectTheme(this)">
                                    <div class="theme-swatch" style="background:linear-gradient(135deg,#881337 50%,#f43f5e 100%)"></div>
                                    <p class="text-xs font-semibold text-gray-700">Rose Gold</p>
                                    <p class="text-[10px] text-gray-400">Stylish</p>
                                </div>

                                <div class="theme-card" data-theme="theme-indigo" onclick="selectTheme(this)">
                                    <div class="theme-swatch" style="background:linear-gradient(135deg,#312e81 50%,#6366f1 100%)"></div>
                                    <p class="text-xs font-semibold text-gray-700">Indigo Academic</p>
                                    <p class="text-[10px] text-gray-400">Smart</p>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const defaultData = [
            {
                type: 'academic', roll: '1001', name: 'Rahul Sharma', father: 'Amit Sharma', dob: '2005-08-15', exam: 'Class 10 Annual',
                subjects: [ {sub:'Math', get:95, tot:100}, {sub:'Science', get:88, tot:100}, {sub:'English', get:92, tot:100} ],
                status: 'live'
            },
            {
                type: 'competition', roll: '2001', name: 'Priya Singh', father: 'Vikram Singh', dob: '2004-02-10', exam: 'National Science Olympiad',
                stats: { totalQ: 100, correct: 80, incorrect: 10, pos: 4, neg: 1 },
                status: 'live'
            }
        ];

        // Init LocalStorage if empty
        if(!localStorage.getItem('rs_data')) localStorage.setItem('rs_data', JSON.stringify(defaultData));
        if(!localStorage.getItem('rs_inst')) localStorage.setItem('rs_inst', JSON.stringify({name: 'Gurukul Public School', addr: '123 Education Lane, Knowledge City', signature: null}));
        if(!localStorage.getItem('rs_exams')) localStorage.setItem('rs_exams', JSON.stringify([
            {name: 'Annual Examination 2024', totalMarks: 500, totalQuestions: 100, correctMarks: 4, wrongMarks: 1}
        ]));
        if(!localStorage.getItem('rs_institutions')) localStorage.setItem('rs_institutions', JSON.stringify([
            {name: 'Gurukul Public School', address: '123 Education Lane, Knowledge City'}
        ]));

        // --- DOM ELEMENTS ---
        const els = {
            searchSec: document.getElementById('search-section'),
            resultWrap: document.getElementById('result-wrapper'),
            resultCont: document.getElementById('result-container'),
            adminModal: document.getElementById('admin-modal'),
            adminLogin: document.getElementById('admin-login-view'),
            adminDash: document.getElementById('admin-dashboard-view'),
            timer: document.getElementById('session-timer'),
            adminReturnBtn: document.getElementById('admin-return-wrapper'),
            studentBackBtn: document.getElementById('student-back-btn')
        };

        // Track if admin is viewing result to change back button behavior
        let isAdminViewing = false;

        // --- STUDENT FUNCTIONS ---
        function searchResult() {
            const roll = document.getElementById('search-roll').value;
            const data = JSON.parse(localStorage.getItem('rs_data'));
            const inst = JSON.parse(localStorage.getItem('rs_inst'));

            const student = data.find(s => s.roll === roll);

            if (!student) {
                alert('Result not found! Try 1001 or 2001');
                return;
            }

            // Check global pause status (admin-only bypass when isAdminViewing)
            const globalPaused = localStorage.getItem('rs_global_status') === 'paused';
            if (!isAdminViewing && globalPaused) {
                document.getElementById('search-section').style.display = 'none';
                document.getElementById('result-paused-section').classList.remove('hidden');
                document.getElementById('paused-roll').innerText = roll;
                return;
            }

            // Check if individual result is paused
            if (!isAdminViewing && student.status === 'paused') {
                document.getElementById('search-section').style.display = 'none';
                document.getElementById('result-paused-section').classList.remove('hidden');
                document.getElementById('paused-roll').innerText = roll;
                return;
            }

            // Get institution details from student's record
            let instData = inst; // Default fallback
            if(student.institution) {
                const institutions = JSON.parse(localStorage.getItem('rs_institutions')) || [];
                const foundInst = institutions.find(i => i.name === student.institution);
                if(foundInst) {
                    instData = {name: foundInst.name, addr: foundInst.address, signature: inst.signature};
                }
            }
            
            // Render Header
            document.getElementById('nav-inst-name').innerText = instData.name;
            document.getElementById('res-inst-name').innerText = instData.name;
            document.getElementById('res-inst-address').innerText = instData.addr;
            
            // Render Student Details
            document.getElementById('res-name').innerText = student.name;
            document.getElementById('res-roll').innerText = student.roll;
            document.getElementById('res-exam-name').innerText = student.exam;

            // Optional Fields Logic: Father's Name
            const fatherWrap = document.getElementById('wrapper-father');
            if (student.father && student.father.trim() !== "") {
                fatherWrap.style.display = 'block';
                document.getElementById('res-father').innerText = student.father;
            } else {
                fatherWrap.style.display = 'none';
            }

            // Optional Fields Logic: DOB
            const dobWrap = document.getElementById('wrapper-dob');
            if (student.dob && student.dob.trim() !== "") {
                dobWrap.style.display = 'block';
                document.getElementById('res-dob').innerText = student.dob;
            } else {
                dobWrap.style.display = 'none';
            }

            // Optional Fields Logic: Signature
            const sigImg = document.getElementById('res-sig-img');
            const sigLine = document.getElementById('res-sig-line');
            const controllerLabel = document.getElementById('res-controller-label');

            if (inst.signature) {
                sigImg.src = inst.signature;
                sigImg.classList.remove('hidden');
                sigLine.classList.add('hidden');
                controllerLabel.classList.remove('hidden');
            } else {
                sigImg.classList.add('hidden');
                sigLine.classList.add('hidden'); // Hide line too - no signature at all
                controllerLabel.classList.add('hidden');
            }


            // Render Body based on Type
            const contentDiv = document.getElementById('dynamic-result-content');
            let totalMarks = 0, obtained = 0, summaryText = "";

            if (student.type === 'academic') {
                let rows = student.subjects.map(s => {
                    obtained += parseFloat(s.get);
                    totalMarks += parseFloat(s.tot);
                    return `<tr class="border-b"><td class="p-2">${s.sub}</td><td class="p-2 text-center">${s.tot}</td><td class="p-2 text-center font-bold">${s.get}</td></tr>`;
                }).join('');
                
                let percent = totalMarks > 0 ? ((obtained/totalMarks)*100).toFixed(2) : 0;
                let grade = percent > 90 ? 'A+' : (percent > 80 ? 'A' : 'B');

                contentDiv.innerHTML = `
                    <table class="w-full border-collapse border border-gray-300">
                        <thead class="bg-gray-100"><tr><th class="border p-2 text-left">Subject</th><th class="border p-2">Max Marks</th><th class="border p-2">Obtained</th></tr></thead>
                        <tbody>${rows}</tbody>
                        <tfoot class="bg-blue-50 font-bold">
                            <tr><td class="p-2 text-right" colspan="2">Total Percentage</td><td class="p-2 text-center text-blue-900">${percent}% (${grade})</td></tr>
                        </tfoot>
                    </table>`;
                
                summaryText = `Name:${student.name}|Roll:${student.roll}|Score:${percent}%`;

            } else {
                // Competition Logic
                const s = student.stats;
                let score = (s.correct * s.pos) - (s.incorrect * s.neg);
                let totalPossible = s.totalQ * s.pos;
                let totalAttempted = s.correct + s.incorrect;
                let accuracy = totalAttempted > 0 ? ((s.correct / totalAttempted) * 100).toFixed(1) : 0;
                let skipped = s.totalQ - totalAttempted;

                contentDiv.innerHTML = `
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-blue-50 p-4 rounded border text-center">
                            <div class="text-4xl font-bold text-blue-700 mb-1">${score}</div>
                            <div class="text-xs text-gray-500 uppercase font-bold">Total Score</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded border text-center">
                            <div class="text-4xl font-bold text-green-600 mb-1">${s.correct}</div>
                            <div class="text-xs text-gray-500 uppercase font-bold">Correct Answers</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded border text-center">
                            <div class="text-4xl font-bold text-red-600 mb-1">${s.incorrect}</div>
                            <div class="text-xs text-gray-500 uppercase font-bold">Wrong Answers</div>
                        </div>
                    </div>
                    <table class="w-full border-collapse border border-gray-200 rounded text-sm mb-4">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="border border-gray-200 p-2 text-left text-gray-600 uppercase text-xs">Metric</th>
                                <th class="border border-gray-200 p-2 text-center text-gray-600 uppercase text-xs">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white"><td class="border border-gray-200 p-2 font-semibold">Total Questions</td><td class="border border-gray-200 p-2 text-center font-bold text-blue-800">${s.totalQ}</td></tr>
                            <tr class="bg-gray-50"><td class="border border-gray-200 p-2 font-semibold">Total Attempted</td><td class="border border-gray-200 p-2 text-center font-bold text-indigo-800">${totalAttempted}</td></tr>
                            <tr class="bg-white"><td class="border border-gray-200 p-2 font-semibold">Skipped / Not Attempted</td><td class="border border-gray-200 p-2 text-center font-bold text-gray-500">${skipped}</td></tr>
                            <tr class="bg-gray-50"><td class="border border-gray-200 p-2 font-semibold">Mark per Correct Answer</td><td class="border border-gray-200 p-2 text-center font-bold text-green-700">+${s.pos}</td></tr>
                            <tr class="bg-white"><td class="border border-gray-200 p-2 font-semibold">Mark per Wrong Answer</td><td class="border border-gray-200 p-2 text-center font-bold text-red-700">-${s.neg}</td></tr>
                            <tr class="bg-gray-50"><td class="border border-gray-200 p-2 font-semibold">Marks Earned (Correct)</td><td class="border border-gray-200 p-2 text-center font-bold text-green-700">+${s.correct * s.pos}</td></tr>
                            <tr class="bg-white"><td class="border border-gray-200 p-2 font-semibold">Marks Deducted (Wrong)</td><td class="border border-gray-200 p-2 text-center font-bold text-red-700">-${s.incorrect * s.neg}</td></tr>
                            <tr class="bg-blue-50 font-bold"><td class="border border-gray-200 p-2 text-blue-900">Net Score / Total Possible</td><td class="border border-gray-200 p-2 text-center text-blue-900">${score} / ${totalPossible}</td></tr>
                            <tr class="bg-white"><td class="border border-gray-200 p-2 font-semibold">Accuracy Rate</td><td class="border border-gray-200 p-2 text-center font-bold">${accuracy}%</td></tr>
                        </tbody>
                    </table>
                `;
                summaryText = `Name:${student.name}|Roll:${student.roll}|Score:${score}/${totalPossible}|Accuracy:${accuracy}%`;
            }

            // Generate QR
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: summaryText,
                width: 80,
                height: 80
            });

            // Switch Views & Handle Buttons
            els.searchSec.style.display = 'none';
            els.resultWrap.classList.remove('hidden');
            els.resultCont.style.display = 'block';

            if (isAdminViewing) {
                els.adminReturnBtn.classList.remove('hidden');
                els.studentBackBtn.classList.add('hidden');
            } else {
                els.adminReturnBtn.classList.add('hidden');
                els.studentBackBtn.classList.remove('hidden');
            }
        }

        function resetSearch() {
            // Standard back for students
            els.resultWrap.classList.add('hidden');
            els.resultCont.style.display = 'none';
            els.searchSec.style.display = 'block';
            document.getElementById('search-roll').value = '';
            els.adminReturnBtn.classList.add('hidden');
            document.getElementById('result-paused-section').classList.add('hidden');
            isAdminViewing = false;
        }

        function backToSearch() {
            // Back from paused message
            document.getElementById('result-paused-section').classList.add('hidden');
            document.getElementById('search-section').style.display = 'block';
            document.getElementById('search-roll').value = '';
        }

        function returnToAdminDashboard() {
            // Back for admins
            els.resultWrap.classList.add('hidden');
            els.resultCont.style.display = 'none';
            els.searchSec.style.display = 'block'; // Reset underlying
            els.adminReturnBtn.classList.add('hidden');
            
            // Re-open modal directly
            els.adminModal.classList.remove('hidden');
            els.adminDash.style.display = 'block';
            els.adminLogin.style.display = 'none';
            isAdminViewing = false;
            startTimer(); // Refresh timer
        }

        function downloadJPG() {
            window.scrollTo(0,0);
            html2canvas(document.getElementById("result-container"), {
                scale: 2, // High Res
                useCORS: true
            }).then(canvas => {
                let link = document.createElement("a");
                document.body.appendChild(link);
                link.download = "result_card.jpg";
                link.href = canvas.toDataURL("image/jpeg", 1.0);
                link.click();
            });
        }

        async function shareResult() {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'My Exam Result',
                        text: 'Check out my result on ResultScope!',
                        url: window.location.href
                    });
                } catch (err) { console.log('Error sharing:', err); }
            } else {
                alert("Sharing not supported on this browser.");
            }
        }

        // --- ADMIN FUNCTIONS ---
        let sessionTime = 1800; // 30 mins
        let timerInterval;

        function toggleAdminPanel() {
            els.adminModal.classList.toggle('hidden');
            // Reset views
            els.adminLogin.style.display = 'block';
            els.adminDash.style.display = 'none';
            clearInterval(timerInterval);
        }

        function adminLogin() {
            if (document.getElementById('admin-pass').value === 'Rajwar@020240') {
                els.adminLogin.style.display = 'none';
                els.adminDash.style.display = 'block';
                startTimer();
                loadSettings();
                loadAllResults();
                loadExamsDropdown();
                loadInstitutionsDropdown();
                loadSubjectPicker();
            } else {
                alert('Wrong Password');
            }
        }

        function startTimer() {
            sessionTime = 1800;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                sessionTime--;
                let min = Math.floor(sessionTime / 60);
                let sec = sessionTime % 60;
                els.timer.innerText = `Session: ${min}:${sec < 10 ? '0'+sec : sec}`;
                
                if(sessionTime <= 0) {
                    alert('Session Expired');
                    toggleAdminPanel();
                }
            }, 1000);
            
            ['mousemove', 'keypress'].forEach(evt => 
                window.addEventListener(evt, () => { if(sessionTime > 0 && !els.adminModal.classList.contains('hidden')) sessionTime = 1800; })
            );
        }

        function switchTab(tab) {
            document.getElementById('tab-upload').classList.add('hidden');
            document.getElementById('tab-settings').classList.add('hidden');
            document.getElementById('tab-view').classList.add('hidden');
            document.getElementById('tab-exams').classList.add('hidden');
            document.getElementById('tab-institutions').classList.add('hidden');
            document.getElementById('tab-edit').classList.add('hidden');
            
            ['upload', 'view', 'settings', 'exams', 'institutions'].forEach(t => {
                document.getElementById(`tab-btn-${t}`).classList.remove('bg-gray-100');
            });

            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-btn-${tab}`).classList.add('bg-gray-100');

            if(tab === 'view') {
                loadAllResults();
                renderGlobalStatusBar();
            } else if(tab === 'upload') {
                loadExamsDropdown();
                loadInstitutionsDropdown();
                loadSubjectPicker();
            } else if(tab === 'exams') {
                loadExamsList();
            } else if(tab === 'institutions') {
                loadInstitutionsList();
            } else if(tab === 'settings') {
                loadManagedSubjectsList();
                markActiveTheme();
            }
        }

        function loadAllResults() {
            const data = JSON.parse(localStorage.getItem('rs_data')) || [];
            const tbody = document.getElementById('admin-results-list');
            const msg = document.getElementById('no-results-msg');
            
            tbody.innerHTML = '';
            renderGlobalStatusBar();
            
            if(data.length === 0) {
                msg.classList.remove('hidden');
                return;
            } else {
                msg.classList.add('hidden');
            }

            data.forEach((s, index) => {
                let statusBadge = s.status === 'live' 
                    ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Live</span>'
                    : '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">Paused</span>';
                
                let statusButton = s.status === 'live'
                    ? `<button onclick="toggleStatus(${index})" class="text-yellow-600 hover:text-yellow-800 text-xs mr-2" title="Pause Result"><i class="fas fa-pause-circle"></i></button>`
                    : `<button onclick="toggleStatus(${index})" class="text-green-600 hover:text-green-800 text-xs mr-2" title="Make Live"><i class="fas fa-play-circle"></i></button>`;
                
                let row = `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium text-gray-900">${s.roll}</td>
                        <td class="px-4 py-3">${s.name}</td>
                        <td class="px-4 py-3 uppercase text-xs">${s.type}</td>
                        <td class="px-4 py-3">${statusBadge}</td>
                        <td class="px-4 py-3 text-right">
                            ${statusButton}
                            <button onclick="editResult(${index})" class="text-blue-600 hover:text-blue-800 text-xs mr-2" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="adminViewResult('${s.roll}')" class="text-gray-600 hover:text-gray-800 text-xs mr-2" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="deleteResult(${index})" class="text-red-600 hover:text-red-800 text-xs" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function adminViewResult(roll) {
            // Close modal temporarily
            els.adminModal.classList.add('hidden');
            isAdminViewing = true;
            document.getElementById('search-roll').value = roll;
            searchResult();
        }

        function toggleFormType() {
            const type = document.getElementById('new-type').value;
            if(type === 'academic') {
                document.getElementById('form-academic').classList.remove('hidden');
                document.getElementById('form-competition').classList.add('hidden');
            } else {
                document.getElementById('form-academic').classList.add('hidden');
                document.getElementById('form-competition').classList.remove('hidden');
            }
        }

        function saveResult() {
            let type = document.getElementById('new-type').value;
            let examSelect = document.getElementById('new-exam');
            let instSelect = document.getElementById('new-institution');
            
            // Allow optional fields to be empty string
            let base = {
                type: type,
                name: document.getElementById('new-name').value,
                roll: document.getElementById('new-roll').value,
                exam: examSelect.value,
                institution: instSelect.value,
                father: document.getElementById('new-father').value,
                dob: document.getElementById('new-dob').value,
                status: (document.querySelector('input[name="new-status"]:checked') || {value:'live'}).value
            };

            if(!base.name || !base.roll || !base.exam || !base.institution) {
                alert("Name, Roll Number, Exam and Institution are required.");
                return;
            }

            if(type === 'academic') {
                // Collect from visual subject builder rows
                const rows = document.querySelectorAll('#subjects-rows tr.subject-row');
                if(rows.length === 0) {
                    alert("Please add at least one subject.");
                    return;
                }
                base.subjects = [];
                let valid = true;
                rows.forEach(row => {
                    const subName = row.getAttribute('data-subject');
                    const marksInput = row.querySelector('.marks-input');
                    const fullMarksInput = row.querySelector('.fullmarks-input');
                    const markVal = parseFloat(marksInput.value);
                    const fullVal = parseFloat(fullMarksInput.value);
                    if(isNaN(markVal) || isNaN(fullVal) || fullVal <= 0) {
                        alert(`Please enter valid marks for: ${subName}`);
                        valid = false;
                    }
                    base.subjects.push({ sub: subName, get: markVal, tot: fullVal });
                });
                if(!valid) return;
            } else {
                base.stats = {
                    totalQ: parseInt(document.getElementById('new-total-q').value),
                    correct: parseInt(document.getElementById('new-correct').value),
                    incorrect: parseInt(document.getElementById('new-incorrect').value),
                    pos: parseInt(document.getElementById('new-pos-mark').value),
                    neg: parseInt(document.getElementById('new-neg-mark').value)
                };
            }

            let currentData = JSON.parse(localStorage.getItem('rs_data'));
            // Remove existing if duplicate roll for simplicity or just push
            currentData = currentData.filter(d => d.roll !== base.roll); 
            currentData.push(base);
            
            localStorage.setItem('rs_data', JSON.stringify(currentData));
            alert('Result Saved! You can now search for Roll: ' + base.roll);
            
            // Clear inputs
            document.getElementById('new-roll').value = '';
            document.getElementById('new-name').value = '';
            // Reset status radio to live
            document.getElementById('new-status-live').checked = true;
            // Clear subject builder
            document.getElementById('subjects-rows').innerHTML = '';
            document.getElementById('subjects-table-container').classList.add('hidden');
            updateSubjectTotals();
            
            loadAllResults();
            sessionTime = 1800; 
        }

        // --- SETTINGS WITH SIGNATURE ---
        let tempSignature = null; // Store base64 here before saving

        function loadSettings() {
            let inst = JSON.parse(localStorage.getItem('rs_inst'));
            document.getElementById('set-inst-name').value = inst.name;
            document.getElementById('set-inst-addr').value = inst.addr;
            
            const preview = document.getElementById('set-sig-preview');
            const placeholder = document.getElementById('set-sig-placeholder');
            
            if(inst.signature) {
                tempSignature = inst.signature;
                preview.src = inst.signature;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                tempSignature = null;
                preview.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }

        // Handle File Input
        document.getElementById('set-sig-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = function() {
                    tempSignature = reader.result;
                    let preview = document.getElementById('set-sig-preview');
                    preview.src = tempSignature;
                    preview.classList.remove('hidden');
                    document.getElementById('set-sig-placeholder').classList.add('hidden');
                }
                reader.readAsDataURL(file);
            }
        });

        function clearSignature() {
            tempSignature = null;
            document.getElementById('set-sig-upload').value = ''; // Reset input
            document.getElementById('set-sig-preview').classList.add('hidden');
            document.getElementById('set-sig-placeholder').classList.remove('hidden');
        }

        function saveSettings() {
            let inst = {
                name: document.getElementById('set-inst-name').value,
                addr: document.getElementById('set-inst-addr').value,
                signature: tempSignature // Save the Base64 string
            };
            localStorage.setItem('rs_inst', JSON.stringify(inst));
            alert('Settings Updated!');
        }

        function adminLogout() {
            if(confirm('Are you sure you want to logout?')) {
                clearInterval(timerInterval);
                sessionTime = 1800;
                document.getElementById('admin-pass').value = '';
                // Reset admin views
                els.adminDash.style.display = 'none';
                els.adminLogin.style.display = 'block';
                // Close the modal
                els.adminModal.classList.add('hidden');
                // Always return to the home (search) page
                els.resultWrap.classList.add('hidden');
                els.resultCont.style.display = 'none';
                els.searchSec.style.display = 'block';
                els.adminReturnBtn.classList.add('hidden');
                document.getElementById('result-paused-section').classList.add('hidden');
                document.getElementById('search-roll').value = '';
                isAdminViewing = false;
            }
        }

        // --- EXAMS MANAGEMENT ---
        function addExam() {
            const exam = {
                name: document.getElementById('exam-name').value,
                totalMarks: parseInt(document.getElementById('exam-total-marks').value) || 0,
                totalQuestions: parseInt(document.getElementById('exam-total-questions').value) || 0,
                correctMarks: parseInt(document.getElementById('exam-correct-marks').value) || 0,
                wrongMarks: parseInt(document.getElementById('exam-wrong-marks').value) || 0
            };

            if(!exam.name) {
                alert('Exam name is required!');
                return;
            }

            let exams = JSON.parse(localStorage.getItem('rs_exams')) || [];
            
            // Check for duplicate
            if(exams.find(e => e.name === exam.name)) {
                alert('Exam with this name already exists!');
                return;
            }

            exams.push(exam);
            localStorage.setItem('rs_exams', JSON.stringify(exams));
            
            // Clear inputs
            document.getElementById('exam-name').value = '';
            document.getElementById('exam-total-marks').value = '';
            document.getElementById('exam-total-questions').value = '';
            document.getElementById('exam-correct-marks').value = '';
            document.getElementById('exam-wrong-marks').value = '';
            
            loadExamsList();
            loadExamsDropdown();
            alert('Exam added successfully!');
        }

        function loadExamsList() {
            const exams = JSON.parse(localStorage.getItem('rs_exams')) || [];
            const tbody = document.getElementById('exams-list');
            const msg = document.getElementById('no-exams-msg');
            
            tbody.innerHTML = '';
            
            if(exams.length === 0) {
                msg.classList.remove('hidden');
                return;
            } else {
                msg.classList.add('hidden');
            }

            exams.forEach((exam, index) => {
                let row = `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium">${exam.name}</td>
                        <td class="px-4 py-3">${exam.totalMarks}</td>
                        <td class="px-4 py-3">${exam.totalQuestions}</td>
                        <td class="px-4 py-3">${exam.correctMarks}</td>
                        <td class="px-4 py-3">${exam.wrongMarks}</td>
                        <td class="px-4 py-3 text-right">
                            <button onclick="deleteExam(${index})" class="text-red-600 hover:text-red-800 text-xs">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function deleteExam(index) {
            if(confirm('Are you sure you want to delete this exam?')) {
                let exams = JSON.parse(localStorage.getItem('rs_exams')) || [];
                exams.splice(index, 1);
                localStorage.setItem('rs_exams', JSON.stringify(exams));
                loadExamsList();
                loadExamsDropdown();
            }
        }

        function loadExamsDropdown() {
            const exams = JSON.parse(localStorage.getItem('rs_exams')) || [];
            const select = document.getElementById('new-exam');
            
            select.innerHTML = '<option value="">-- Select Exam --</option>';
            
            exams.forEach(exam => {
                select.innerHTML += `<option value="${exam.name}">${exam.name}</option>`;
            });
        }

        // --- INSTITUTIONS MANAGEMENT ---
        function addInstitution() {
            const institution = {
                name: document.getElementById('inst-name').value,
                address: document.getElementById('inst-address').value
            };

            if(!institution.name || !institution.address) {
                alert('Institution name and address are required!');
                return;
            }

            let institutions = JSON.parse(localStorage.getItem('rs_institutions')) || [];
            
            // Check for duplicate
            if(institutions.find(i => i.name === institution.name)) {
                alert('Institution with this name already exists!');
                return;
            }

            institutions.push(institution);
            localStorage.setItem('rs_institutions', JSON.stringify(institutions));
            
            // Clear inputs
            document.getElementById('inst-name').value = '';
            document.getElementById('inst-address').value = '';
            
            loadInstitutionsList();
            loadInstitutionsDropdown();
            alert('Institution added successfully!');
        }

        function loadInstitutionsList() {
            const institutions = JSON.parse(localStorage.getItem('rs_institutions')) || [];
            const tbody = document.getElementById('institutions-list');
            const msg = document.getElementById('no-institutions-msg');
            
            tbody.innerHTML = '';
            
            if(institutions.length === 0) {
                msg.classList.remove('hidden');
                return;
            } else {
                msg.classList.add('hidden');
            }

            institutions.forEach((inst, index) => {
                let row = `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium">${inst.name}</td>
                        <td class="px-4 py-3">${inst.address}</td>
                        <td class="px-4 py-3 text-right">
                            <button onclick="deleteInstitution(${index})" class="text-red-600 hover:text-red-800 text-xs">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function deleteInstitution(index) {
            if(confirm('Are you sure you want to delete this institution?')) {
                let institutions = JSON.parse(localStorage.getItem('rs_institutions')) || [];
                institutions.splice(index, 1);
                localStorage.setItem('rs_institutions', JSON.stringify(institutions));
                loadInstitutionsList();
                loadInstitutionsDropdown();
            }
        }

        function loadInstitutionsDropdown() {
            const institutions = JSON.parse(localStorage.getItem('rs_institutions')) || [];
            const select = document.getElementById('new-institution');
            
            select.innerHTML = '<option value="">-- Select Institution --</option>';
            
            institutions.forEach(inst => {
                select.innerHTML += `<option value="${inst.name}">${inst.name}</option>`;
            });
        }

        // --- EDIT AND STATUS MANAGEMENT ---
        function toggleStatus(index) {
            let data = JSON.parse(localStorage.getItem('rs_data')) || [];
            
            if (data[index]) {
                data[index].status = data[index].status === 'live' ? 'paused' : 'live';
                localStorage.setItem('rs_data', JSON.stringify(data));
                loadAllResults();
                alert(`Result ${data[index].status === 'live' ? 'is now LIVE ✅' : 'has been PAUSED ⏸️'}`);
            }
        }

        function deleteResult(index) {
            let data = JSON.parse(localStorage.getItem('rs_data')) || [];
            if (!data[index]) return;
            const name = data[index].name;
            const roll = data[index].roll;
            if (confirm(`Are you sure you want to permanently delete the result of:\n\n${name} (Roll: ${roll})?\n\nThis cannot be undone.`)) {
                data.splice(index, 1);
                localStorage.setItem('rs_data', JSON.stringify(data));
                loadAllResults();
                alert('Result deleted successfully.');
            }
        }

        function deleteResultFromEdit() {
            const originalRoll = document.getElementById('edit-original-roll').value;
            let data = JSON.parse(localStorage.getItem('rs_data')) || [];
            const index = data.findIndex(d => d.roll === originalRoll);
            if (index === -1) return;
            const name = data[index].name;
            if (confirm(`Are you sure you want to permanently delete the result of:\n\n${name} (Roll: ${originalRoll})?\n\nThis cannot be undone.`)) {
                data.splice(index, 1);
                localStorage.setItem('rs_data', JSON.stringify(data));
                alert('Result deleted successfully.');
                cancelEdit();
            }
        }

        function toggleStatusFromEdit() {
            const originalRoll = document.getElementById('edit-original-roll').value;
            let data = JSON.parse(localStorage.getItem('rs_data')) || [];
            const index = data.findIndex(d => d.roll === originalRoll);
            if (index === -1) return;
            data[index].status = data[index].status === 'live' ? 'paused' : 'live';
            localStorage.setItem('rs_data', JSON.stringify(data));
            updateEditStatusToggleBtn(data[index].status);
            alert(`Result ${data[index].status === 'live' ? 'is now LIVE ✅' : 'has been PAUSED ⏸️'}`);
        }

        function updateEditStatusToggleBtn(status) {
            const btn = document.getElementById('edit-status-toggle-btn');
            const label = document.getElementById('edit-status-toggle-label');
            if (!btn) return;
            if (status === 'live') {
                btn.className = 'flex-1 py-2 rounded font-bold text-sm text-white transition bg-yellow-500 hover:bg-yellow-600';
                label.innerHTML = '<i class="fas fa-pause-circle mr-1"></i>Pause Result';
            } else {
                btn.className = 'flex-1 py-2 rounded font-bold text-sm text-white transition bg-green-600 hover:bg-green-700';
                label.innerHTML = '<i class="fas fa-play-circle mr-1"></i>Make Live';
            }
        }

        function toggleGlobalStatus() {
            const current = localStorage.getItem('rs_global_status') || 'live';
            const newStatus = current === 'live' ? 'paused' : 'live';
            localStorage.setItem('rs_global_status', newStatus);
            renderGlobalStatusBar();
            alert(newStatus === 'paused'
                ? '⏸️ All results are now PAUSED. Students will see "Result Coming Soon".'
                : '✅ All results are now LIVE. Students can view their results.');
        }

        function renderGlobalStatusBar() {
            const status = localStorage.getItem('rs_global_status') || 'live';
            const bar = document.getElementById('global-status-bar');
            const label = document.getElementById('global-status-label');
            const desc = document.getElementById('global-status-desc');
            const btn = document.getElementById('global-status-btn');
            if (!bar) return;
            if (status === 'live') {
                bar.className = 'mb-3 p-3 rounded border flex items-center justify-between bg-green-50 border-green-300';
                label.innerHTML = '<i class="fas fa-circle text-green-500 mr-2 text-xs"></i>All Results: LIVE';
                label.className = 'font-bold text-sm text-green-800';
                desc.innerText = 'Students can view their results normally.';
                btn.className = 'px-4 py-2 rounded font-bold text-sm text-white transition bg-yellow-500 hover:bg-yellow-600';
                btn.innerHTML = '<i class="fas fa-pause-circle mr-1"></i>Pause All';
            } else {
                bar.className = 'mb-3 p-3 rounded border flex items-center justify-between bg-yellow-50 border-yellow-300';
                label.innerHTML = '<i class="fas fa-pause-circle text-yellow-500 mr-2 text-xs"></i>All Results: PAUSED';
                label.className = 'font-bold text-sm text-yellow-800';
                desc.innerText = 'All students see "Result Coming Soon". Individual statuses are overridden.';
                btn.className = 'px-4 py-2 rounded font-bold text-sm text-white transition bg-green-600 hover:bg-green-700';
                btn.innerHTML = '<i class="fas fa-play-circle mr-1"></i>Make All Live';
            }
        }

        function editResult(index) {
            let data = JSON.parse(localStorage.getItem('rs_data')) || [];
            let result = data[index];
            
            if (!result) return;
            
            // Load exam and institution dropdowns
            loadExamsDropdown();
            loadInstitutionsDropdown();
            
            // Also load for edit form
            const exams = JSON.parse(localStorage.getItem('rs_exams')) || [];
            const institutions = JSON.parse(localStorage.getItem('rs_institutions')) || [];
            
            const editExamSelect = document.getElementById('edit-exam');
            const editInstSelect = document.getElementById('edit-institution');
            
            editExamSelect.innerHTML = '<option value="">-- Select Exam --</option>';
            exams.forEach(exam => {
                editExamSelect.innerHTML += `<option value="${exam.name}">${exam.name}</option>`;
            });
            
            editInstSelect.innerHTML = '<option value="">-- Select Institution --</option>';
            institutions.forEach(inst => {
                editInstSelect.innerHTML += `<option value="${inst.name}">${inst.name}</option>`;
            });
            
            // Store original roll for updating
            document.getElementById('edit-original-roll').value = result.roll;
            
            // Fill form
            document.getElementById('edit-type').value = result.type;
            document.getElementById('edit-name').value = result.name;
            document.getElementById('edit-roll').value = result.roll;
            document.getElementById('edit-exam').value = result.exam || '';
            document.getElementById('edit-institution').value = result.institution || '';
            document.getElementById('edit-father').value = result.father || '';
            document.getElementById('edit-dob').value = result.dob || '';
            
            if (result.type === 'academic') {
                document.getElementById('edit-form-academic').classList.remove('hidden');
                document.getElementById('edit-form-competition').classList.add('hidden');
                
                // Load subject picker for edit form
                loadEditSubjectPicker();
                
                // Clear existing rows
                document.getElementById('edit-subjects-rows').innerHTML = '';
                document.getElementById('edit-subjects-table-container').classList.add('hidden');
                
                // Fill subjects using the visual builder
                result.subjects.forEach(s => {
                    addEditSubjectRowData(s.sub, parseFloat(s.get), parseFloat(s.tot));
                });
                updateEditSubjectTotals();
            } else {
                document.getElementById('edit-form-academic').classList.add('hidden');
                document.getElementById('edit-form-competition').classList.remove('hidden');
                
                // Fill competition stats
                document.getElementById('edit-total-q').value = result.stats.totalQ;
                document.getElementById('edit-correct').value = result.stats.correct;
                document.getElementById('edit-incorrect').value = result.stats.incorrect;
                document.getElementById('edit-pos-mark').value = result.stats.pos;
                document.getElementById('edit-neg-mark').value = result.stats.neg;
            }
            
            // Switch to edit tab
            document.getElementById('tab-view').classList.add('hidden');
            document.getElementById('tab-edit').classList.remove('hidden');
            document.getElementById('tab-btn-view').classList.remove('bg-gray-100');
            
            // Set edit status toggle button state
            updateEditStatusToggleBtn(result.status || 'live');
        }

        function cancelEdit() {
            document.getElementById('tab-edit').classList.add('hidden');
            document.getElementById('tab-view').classList.remove('hidden');
            document.getElementById('tab-btn-view').classList.add('bg-gray-100');
            loadAllResults();
        }

        function toggleEditFormType() {
            const type = document.getElementById('edit-type').value;
            if(type === 'academic') {
                document.getElementById('edit-form-academic').classList.remove('hidden');
                document.getElementById('edit-form-competition').classList.add('hidden');
                loadEditSubjectPicker();
            } else {
                document.getElementById('edit-form-academic').classList.add('hidden');
                document.getElementById('edit-form-competition').classList.remove('hidden');
            }
        }

        function updateResult() {
            let originalRoll = document.getElementById('edit-original-roll').value;
            let type = document.getElementById('edit-type').value;
            let examSelect = document.getElementById('edit-exam');
            let instSelect = document.getElementById('edit-institution');
            
            let updated = {
                type: type,
                name: document.getElementById('edit-name').value,
                roll: document.getElementById('edit-roll').value,
                exam: examSelect.value,
                institution: instSelect.value,
                father: document.getElementById('edit-father').value,
                dob: document.getElementById('edit-dob').value
            };

            if(!updated.name || !updated.roll || !updated.exam || !updated.institution) {
                alert("Name, Roll Number, Exam and Institution are required.");
                return;
            }

            if(type === 'academic') {
                const editRows = document.querySelectorAll('#edit-subjects-rows tr.edit-subject-row');
                if(editRows.length === 0) {
                    alert("Please add at least one subject.");
                    return;
                }
                updated.subjects = [];
                let valid = true;
                editRows.forEach(row => {
                    const subName = row.getAttribute('data-subject');
                    const markVal = parseFloat(row.querySelector('.edit-marks-input').value);
                    const fullVal = parseFloat(row.querySelector('.edit-fullmarks-input').value);
                    if(isNaN(markVal) || isNaN(fullVal) || fullVal <= 0) {
                        alert(`Please enter valid marks for: ${subName}`);
                        valid = false;
                    }
                    updated.subjects.push({ sub: subName, get: markVal, tot: fullVal });
                });
                if(!valid) return;
            } else {
                updated.stats = {
                    totalQ: parseInt(document.getElementById('edit-total-q').value),
                    correct: parseInt(document.getElementById('edit-correct').value),
                    incorrect: parseInt(document.getElementById('edit-incorrect').value),
                    pos: parseInt(document.getElementById('edit-pos-mark').value),
                    neg: parseInt(document.getElementById('edit-neg-mark').value)
                };
            }

            let data = JSON.parse(localStorage.getItem('rs_data'));
            
            // Find and update the result, preserve status
            let index = data.findIndex(d => d.roll === originalRoll);
            if (index !== -1) {
                updated.status = data[index].status; // Preserve status
                data[index] = updated;
                localStorage.setItem('rs_data', JSON.stringify(data));
                alert('Result Updated Successfully!');
                cancelEdit();
            } else {
                alert('Error: Original result not found');
            }
        }

        // ===== SUBJECT BUILDER FUNCTIONS =====

        // Init default subjects if not present
        if(!localStorage.getItem('rs_subjects')) {
            localStorage.setItem('rs_subjects', JSON.stringify([
                'Mathematics','Science','Physics','Chemistry','Biology',
                'English','Hindi','Social Studies','Computer Science','History',
                'Geography','Economics','Civics','Sanskrit','Physical Education'
            ]));
        }

        function loadSubjectPicker() {
            const subjects = JSON.parse(localStorage.getItem('rs_subjects')) || [];
            const picker = document.getElementById('subject-picker');
            if(!picker) return;
            picker.innerHTML = '<option value="">-- Select Subject --</option>';
            subjects.forEach(s => {
                picker.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }

        function addSubjectRow() {
            const picker = document.getElementById('subject-picker');
            const subjectName = picker.value;
            const fullMarks = document.getElementById('subject-fullmarks').value || 100;

            if(!subjectName) { alert('Please select a subject first.'); return; }

            // Check not duplicate
            const existing = document.querySelectorAll('#subjects-rows tr.subject-row');
            for(let row of existing) {
                if(row.getAttribute('data-subject') === subjectName) {
                    alert(`${subjectName} is already added.`);
                    return;
                }
            }

            const tbody = document.getElementById('subjects-rows');
            const tr = document.createElement('tr');
            tr.className = 'subject-row border-b';
            tr.setAttribute('data-subject', subjectName);
            tr.innerHTML = `
                <td class="p-2 text-sm font-medium">${subjectName}</td>
                <td class="p-2 text-center"><input type="number" class="marks-input subject-row-input" placeholder="0" min="0" max="${fullMarks}" oninput="updateSubjectTotals()"></td>
                <td class="p-2 text-center"><input type="number" class="fullmarks-input subject-row-input" value="${fullMarks}" min="1" oninput="updateSubjectTotals()"></td>
                <td class="p-2 text-center text-xs font-bold row-percent text-blue-600">—</td>
                <td class="p-2 text-center"><button type="button" onclick="removeSubjectRow(this)" class="text-red-500 hover:text-red-700 text-xs"><i class="fas fa-times"></i></button></td>
            `;
            tbody.appendChild(tr);
            document.getElementById('subjects-table-container').classList.remove('hidden');
            picker.value = '';
            updateSubjectTotals();
        }

        function removeSubjectRow(btn) {
            btn.closest('tr').remove();
            const rows = document.querySelectorAll('#subjects-rows tr.subject-row');
            if(rows.length === 0) document.getElementById('subjects-table-container').classList.add('hidden');
            updateSubjectTotals();
        }

        function updateSubjectTotals() {
            let totalObt = 0, totalFull = 0;
            const rows = document.querySelectorAll('#subjects-rows tr.subject-row');
            rows.forEach(row => {
                const obt = parseFloat(row.querySelector('.marks-input').value) || 0;
                const full = parseFloat(row.querySelector('.fullmarks-input').value) || 0;
                totalObt += obt;
                totalFull += full;
                const pct = full > 0 ? ((obt/full)*100).toFixed(1) : '—';
                row.querySelector('.row-percent').innerText = full > 0 ? pct + '%' : '—';
            });

            const pct = totalFull > 0 ? ((totalObt/totalFull)*100).toFixed(2) + '%' : '—';
            document.getElementById('total-obtained').innerText = rows.length ? totalObt : '—';
            document.getElementById('total-fullmarks').innerText = rows.length ? totalFull : '—';
            document.getElementById('total-percent').innerText = rows.length ? pct : '—';
        }

        function saveCustomSubject() {
            const input = document.getElementById('custom-subject-name');
            const name = input.value.trim();
            if(!name) { alert('Please type a subject name.'); return; }

            let subjects = JSON.parse(localStorage.getItem('rs_subjects')) || [];
            if(subjects.includes(name)) { alert('Subject already exists in the list.'); return; }

            subjects.push(name);
            localStorage.setItem('rs_subjects', JSON.stringify(subjects));
            input.value = '';
            loadSubjectPicker();
            alert(`"${name}" added to subject list!`);
        }

        // ===== MANAGED SUBJECTS (Settings) =====

        function addManagedSubject() {
            const input = document.getElementById('manage-subject-input');
            const name = input.value.trim();
            if(!name) return;

            let subjects = JSON.parse(localStorage.getItem('rs_subjects')) || [];
            if(subjects.includes(name)) { alert('Already exists.'); return; }
            subjects.push(name);
            localStorage.setItem('rs_subjects', JSON.stringify(subjects));
            input.value = '';
            loadManagedSubjectsList();
            loadSubjectPicker();
        }

        function removeManagedSubject(name) {
            let subjects = JSON.parse(localStorage.getItem('rs_subjects')) || [];
            subjects = subjects.filter(s => s !== name);
            localStorage.setItem('rs_subjects', JSON.stringify(subjects));
            loadManagedSubjectsList();
            loadSubjectPicker();
        }

        function loadManagedSubjectsList() {
            const subjects = JSON.parse(localStorage.getItem('rs_subjects')) || [];
            const container = document.getElementById('managed-subjects-list');
            if(!container) return;
            container.innerHTML = '';
            if(subjects.length === 0) {
                container.innerHTML = '<span class="text-xs text-gray-400">No subjects yet.</span>';
                return;
            }
            subjects.forEach(s => {
                const tag = document.createElement('span');
                tag.className = 'inline-flex items-center gap-1 bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full';
                tag.innerHTML = `${s} <button onclick="removeManagedSubject('${s.replace(/'/g, "\\'")}')" class="ml-1 text-blue-400 hover:text-red-600 font-bold leading-none">&times;</button>`;
                container.appendChild(tag);
            });
        }

        // ===== EDIT FORM SUBJECT BUILDER FUNCTIONS =====

        function loadEditSubjectPicker() {
            const subjects = JSON.parse(localStorage.getItem('rs_subjects')) || [];
            const picker = document.getElementById('edit-subject-picker');
            if(!picker) return;
            picker.innerHTML = '<option value="">-- Select Subject --</option>';
            subjects.forEach(s => {
                picker.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }

        function addEditSubjectRow() {
            const picker = document.getElementById('edit-subject-picker');
            const subjectName = picker.value;
            const fullMarks = document.getElementById('edit-subject-fullmarks').value || 100;
            if(!subjectName) { alert('Please select a subject first.'); return; }
            const existing = document.querySelectorAll('#edit-subjects-rows tr.edit-subject-row');
            for(let row of existing) {
                if(row.getAttribute('data-subject') === subjectName) {
                    alert(`${subjectName} is already added.`); return;
                }
            }
            addEditSubjectRowData(subjectName, '', parseFloat(fullMarks));
            picker.value = '';
            updateEditSubjectTotals();
        }

        function addEditSubjectRowData(subjectName, marksObtained, fullMarks) {
            const tbody = document.getElementById('edit-subjects-rows');
            const tr = document.createElement('tr');
            tr.className = 'edit-subject-row border-b';
            tr.setAttribute('data-subject', subjectName);
            tr.innerHTML = `
                <td class="p-2 text-sm font-medium">${subjectName}</td>
                <td class="p-2 text-center"><input type="number" class="edit-marks-input subject-row-input" value="${marksObtained !== '' ? marksObtained : ''}" placeholder="0" min="0" oninput="updateEditSubjectTotals()"></td>
                <td class="p-2 text-center"><input type="number" class="edit-fullmarks-input subject-row-input" value="${fullMarks}" min="1" oninput="updateEditSubjectTotals()"></td>
                <td class="p-2 text-center text-xs font-bold edit-row-percent text-blue-600">—</td>
                <td class="p-2 text-center"><button type="button" onclick="removeEditSubjectRow(this)" class="text-red-500 hover:text-red-700 text-xs"><i class="fas fa-times"></i></button></td>
            `;
            tbody.appendChild(tr);
            document.getElementById('edit-subjects-table-container').classList.remove('hidden');
            updateEditSubjectTotals();
        }

        function removeEditSubjectRow(btn) {
            btn.closest('tr').remove();
            const rows = document.querySelectorAll('#edit-subjects-rows tr.edit-subject-row');
            if(rows.length === 0) document.getElementById('edit-subjects-table-container').classList.add('hidden');
            updateEditSubjectTotals();
        }

        function updateEditSubjectTotals() {
            let totalObt = 0, totalFull = 0;
            const rows = document.querySelectorAll('#edit-subjects-rows tr.edit-subject-row');
            rows.forEach(row => {
                const obt = parseFloat(row.querySelector('.edit-marks-input').value) || 0;
                const full = parseFloat(row.querySelector('.edit-fullmarks-input').value) || 0;
                totalObt += obt;
                totalFull += full;
                const pct = full > 0 ? ((obt/full)*100).toFixed(1) : '—';
                row.querySelector('.edit-row-percent').innerText = full > 0 ? pct + '%' : '—';
            });
            const pct = totalFull > 0 ? ((totalObt/totalFull)*100).toFixed(2) + '%' : '—';
            document.getElementById('edit-total-obtained').innerText = rows.length ? totalObt : '—';
            document.getElementById('edit-total-fullmarks').innerText = rows.length ? totalFull : '—';
            document.getElementById('edit-total-percent').innerText = rows.length ? pct : '—';
        }

        function saveEditCustomSubject() {
            const input = document.getElementById('edit-custom-subject-name');
            const name = input.value.trim();
            if(!name) { alert('Please type a subject name.'); return; }
            let subjects = JSON.parse(localStorage.getItem('rs_subjects')) || [];
            if(subjects.includes(name)) { alert('Subject already exists in the list.'); return; }
            subjects.push(name);
            localStorage.setItem('rs_subjects', JSON.stringify(subjects));
            input.value = '';
            loadEditSubjectPicker();
            loadSubjectPicker();
            alert(`"${name}" added to subject list!`);
        }

        // ===== THEME FUNCTIONS =====

        const allThemes = ['', 'theme-purple', 'theme-green', 'theme-red', 'theme-teal', 'theme-dark', 'theme-orange', 'theme-rose', 'theme-indigo'];

        function applyTheme(themeClass) {
            // Remove all themes
            allThemes.forEach(t => { if(t) document.body.classList.remove(t); });
            if(themeClass) document.body.classList.add(themeClass);
            localStorage.setItem('rs_theme', themeClass);
        }

        function selectTheme(card) {
            const themeClass = card.getAttribute('data-theme');
            applyTheme(themeClass);
            markActiveTheme();
        }

        function markActiveTheme() {
            const current = localStorage.getItem('rs_theme') || '';
            document.querySelectorAll('.theme-card').forEach(c => {
                c.classList.toggle('selected', c.getAttribute('data-theme') === current);
            });
        }

        // Apply saved theme on page load
        const savedTheme = localStorage.getItem('rs_theme') || '';
        applyTheme(savedTheme);

    </script>
</body>
</html>


