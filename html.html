<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExamPortal Elite - Professional Result System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* --- CORE ANIMATIONS --- */
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- UTILITIES --- */
        .modal-bg { background-color: rgba(17, 24, 39, 0.7); backdrop-filter: blur(4px); }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #4f46e5; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- A4 JPG RESULT CARD STYLES --- */
        .result-card-a4 {
            width: 794px;
            height: 1123px;
            background: white;
            position: relative;
            font-family: 'Arial', sans-serif;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .watermark-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 120px;
            color: rgba(0,0,0,0.03);
            font-weight: bold;
            z-index: 0;
            pointer-events: none;
        }

        /* Prevent layout shift during capture */
        #capture-zone { position: fixed; left: -9999px; top: 0; z-index: -1; }
        
        /* Print friendly */
        @media print {
            body * { visibility: hidden; }
            .result-card-a4, .result-card-a4 * { visibility: visible; }
            .result-card-a4 { position: absolute; left: 0; top: 0; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased selection:bg-indigo-100 selection:text-indigo-700">

    <!-- HIDDEN CAPTURE ZONE FOR A4 JPG GENERATION -->
    <div id="capture-zone"></div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-2xl opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center gap-3">
        <i class="fas fa-info-circle text-indigo-400"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <!-- NAVIGATION -->
    <nav class="bg-white shadow-md sticky top-0 z-40 border-b border-gray-100">
        <div class="container mx-auto px-4 md:px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2 text-2xl font-bold text-gray-900 tracking-tight">
                <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white text-lg shadow-indigo-200 shadow-lg">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <span id="nav-title">ExamPortal</span>
            </div>
            <div class="flex gap-2">
                <button onclick="switchView('student')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition">Result Search</button>
                <button onclick="switchView('login')" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 rounded-lg transition shadow-md">Admin</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8 min-h-[calc(100vh-80px)]">

        <!-- STUDENT RESULT SEARCH VIEW -->
        <section id="view-student" class="max-w-2xl mx-auto fade-in">
            
            <!-- RESULTS NOT LIVE MESSAGE -->
            <div id="results-not-live" class="hidden text-center py-20">
                <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-3xl p-12 shadow-2xl border-2 border-indigo-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                    
                    <div class="mb-8">
                        <div class="inline-block p-6 bg-white rounded-full shadow-lg mb-6">
                            <i class="fas fa-clock text-6xl text-indigo-600"></i>
                        </div>
                        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-4">
                            Results Coming Soon! ðŸŽ“
                        </h1>
                        <p class="text-xl text-gray-600 mb-6 max-w-md mx-auto">
                            We're currently processing your examination results. They will be published shortly.
                        </p>
                    </div>

                    <div class="bg-white rounded-2xl p-8 shadow-md border border-indigo-100 max-w-lg mx-auto mb-8">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center justify-center gap-2">
                            <i class="fas fa-info-circle text-indigo-600"></i>
                            What's Next?
                        </h3>
                        <ul class="text-left space-y-3 text-gray-700">
                            <li class="flex items-start gap-3">
                                <span class="text-green-500 text-xl">âœ“</span>
                                <span>Your results are being carefully verified by our team</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="text-green-500 text-xl">âœ“</span>
                                <span>You'll be notified as soon as results are published</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="text-green-500 text-xl">âœ“</span>
                                <span>Check back here regularly for updates</span>
                            </li>
                        </ul>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                        <div class="bg-indigo-100 text-indigo-800 px-6 py-3 rounded-full font-bold text-sm">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            Exam: <span id="results-wait-exam">Annual Board Examination 2026</span>
                        </div>
                        <div class="bg-purple-100 text-purple-800 px-6 py-3 rounded-full font-bold text-sm">
                            <i class="fas fa-users mr-2"></i>
                            <span id="results-wait-count">0</span> Students Appeared
                        </div>
                    </div>

                    <div class="mt-8 text-sm text-gray-500">
                        <p>For any queries, please contact the administration</p>
                    </div>
                </div>
            </div>

            <!-- SEARCH INTERFACE (only visible when results are live) -->
            <div id="search-interface">
                <div class="text-center mb-10 space-y-2">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900" id="exam-title-display">Check Your Performance</h1>
                    <p class="text-gray-500" id="exam-subtitle-display">Enter your official credentials to view the result.</p>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-gray-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                    
                    <div class="flex flex-col gap-4">
                        <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Search Candidate</label>
                        <div class="flex gap-2">
                            <input type="text" id="search-input" placeholder="Enter Roll Number or Name..." class="flex-1 bg-gray-50 border border-gray-200 text-gray-900 text-lg rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 outline-none transition" onkeypress="if(event.key==='Enter') findStudent()">
                            <button onclick="findStudent()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl px-6 py-3 transition shadow-lg shadow-indigo-200">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <p id="search-error" class="text-red-500 text-sm font-medium hidden"><i class="fas fa-exclamation-circle mr-1"></i> No record found.</p>
                    </div>
                </div>
            </div>

            <!-- RESULT DISPLAY CARD -->
            <div id="result-display" class="hidden mt-8 bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-200 fade-in">
                <div class="bg-gray-900 p-6 flex justify-between items-center text-white">
                    <div>
                        <h2 class="text-2xl font-bold" id="disp-name">Student Name</h2>
                        <p class="text-gray-400 font-mono">Roll: <span id="disp-roll">1001</span></p>
                    </div>
                    <div class="text-center">
                        <span class="block text-xs text-gray-400 uppercase font-bold">Overall Rank</span>
                        <span class="text-3xl font-bold text-yellow-400" id="disp-rank">#1</span>
                    </div>
                </div>

                <div class="p-6 grid grid-cols-2 md:grid-cols-5 gap-4 bg-gray-50 border-b">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center">
                        <div class="text-xs text-gray-500 font-bold uppercase">Total Qs</div>
                        <div class="text-2xl font-bold text-gray-800" id="disp-total">100</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 text-center">
                        <div class="text-xs text-blue-600 font-bold uppercase">Attempted</div>
                        <div class="text-2xl font-bold text-blue-600" id="disp-attempted">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-green-100 text-center">
                        <div class="text-xs text-green-600 font-bold uppercase">Correct</div>
                        <div class="text-2xl font-bold text-green-600" id="disp-right">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-red-100 text-center">
                        <div class="text-xs text-red-600 font-bold uppercase">Wrong</div>
                        <div class="text-2xl font-bold text-red-600" id="disp-wrong">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-indigo-100 text-center">
                        <div class="text-xs text-indigo-600 font-bold uppercase">Marks</div>
                        <div class="text-2xl font-bold text-indigo-600" id="disp-marks">0</div>
                    </div>
                </div>

                <div class="p-6 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="text-4xl font-bold text-gray-800" id="disp-percent">0%</div>
                        <div id="disp-badge" class="px-3 py-1 rounded-full text-sm font-bold uppercase bg-gray-200 text-gray-600">Status</div>
                    </div>
                    
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="shareResultWhatsApp()" class="flex-1 md:flex-none px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-sm transition flex items-center justify-center gap-2">
                            <i class="fab fa-whatsapp"></i> Share
                        </button>
                        <button onclick="generateResultJPG('student')" class="flex-1 md:flex-none px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-sm transition flex items-center justify-center gap-2">
                            <i class="fas fa-image"></i> Download JPG
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ADMIN LOGIN VIEW -->
        <section id="view-login" class="hidden max-w-md mx-auto fade-in pt-10">
            <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200 text-center">
                <div class="mb-6 inline-block p-4 rounded-full bg-indigo-50 text-indigo-600 text-3xl">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Admin Portal</h2>
                <input type="password" id="admin-pass" placeholder="Enter Password" class="w-full mb-4 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" onkeypress="if(event.key==='Enter') handleLogin()">
                <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">Access Dashboard</button>
                <p id="login-msg" class="text-red-500 mt-3 text-sm hidden">Invalid Credentials</p>
                
                <button onclick="openPasswordRecovery()" class="mt-4 text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                    <i class="fas fa-key mr-1"></i>Forgot Password?
                </button>
            </div>
        </section>

        <!-- PASSWORD RECOVERY MODAL -->
        <div id="modal-password-recovery" class="fixed inset-0 modal-bg hidden z-50 flex items-center justify-center fade-in">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden m-4">
                <div class="bg-indigo-600 p-4 flex justify-between items-center text-white">
                    <h3 class="font-bold"><i class="fas fa-key mr-2"></i>Password Recovery</h3>
                    <button onclick="closePasswordRecovery()" class="hover:text-gray-300"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-6">
                    <div class="text-center mb-6">
                        <div class="inline-block p-4 bg-indigo-50 rounded-full mb-4">
                            <i class="fas fa-lock text-3xl text-indigo-600"></i>
                        </div>
                        <p class="text-gray-600 text-sm">Your password is stored securely. Please contact your system administrator or check your recovery email.</p>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-blue-900 font-semibold mb-2">
                            <i class="fas fa-envelope mr-2"></i>Recovery Email:
                        </p>
                        <p class="text-blue-700 font-mono text-sm" id="recovery-email-display">Not configured</p>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <p class="text-xs text-yellow-800">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>Security Note:</strong> For security reasons, passwords cannot be displayed. If you're the administrator, you can reset it from the exam configuration panel.
                        </p>
                    </div>

                    <button onclick="closePasswordRecovery()" class="w-full bg-gray-800 hover:bg-gray-900 text-white py-3 rounded-lg font-bold transition">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- ADMIN DASHBOARD VIEW -->
        <section id="view-dashboard" class="hidden w-full max-w-7xl mx-auto fade-in">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4 pb-6 border-b border-gray-200">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900">Dashboard</h2>
                    <p class="text-gray-500 mt-1">Manage Results, Rank List & Configuration</p>
                    
                    <!-- Session Timer -->
                    <div class="mt-3 inline-flex items-center gap-2 bg-green-50 border border-green-200 px-4 py-2 rounded-lg">
                        <i class="fas fa-clock text-green-600"></i>
                        <span class="text-sm font-semibold text-green-800">Session: <span id="session-timer">30:00</span></span>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="openModal('exam-config')" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 transition shadow-lg">
                        <i class="fas fa-cog mr-2"></i> Exam Config
                    </button>
                    <button onclick="openModal('add')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">
                        <i class="fas fa-plus mr-2"></i> Add Student
                    </button>
                    <button onclick="generateMeritListJPG()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition">
                        <i class="fas fa-image mr-2"></i> Merit List JPG
                    </button>
                    <button onclick="logout()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-50 transition">
                        Log Out
                    </button>
                </div>
            </div>

            <!-- ADMIN TABLE -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                <div class="p-4 bg-gray-50 border-b flex flex-col md:flex-row justify-between items-center gap-3">
                    <div class="font-bold text-gray-700 uppercase text-sm tracking-wider">Live Ranking Table</div>
                    <input type="text" id="admin-search" placeholder="Search by Roll/Name..." class="border rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" oninput="renderAdminTable()">
                    <div class="text-sm text-gray-500">Total Records: <span id="total-count" class="font-bold text-gray-900">0</span></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase font-bold">
                            <tr>
                                <th class="p-4">Rank</th>
                                <th class="p-4">Roll</th>
                                <th class="p-4">Name</th>
                                <th class="p-4 text-center">Marks</th>
                                <th class="p-4 text-center">%</th>
                                <th class="p-4 text-center">Status</th>
                                <th class="p-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-tbody" class="divide-y divide-gray-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <!-- MODAL FOR ADD/EDIT STUDENT -->
    <div id="modal" class="fixed inset-0 modal-bg hidden z-50 flex items-center justify-center fade-in">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden m-4">
            <div class="bg-gray-900 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold" id="modal-title">Add Student</h3>
                <button onclick="closeModal()" class="hover:text-gray-300"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-roll-ref">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Full Name</label>
                    <input id="inp-name" type="text" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Roll No</label>
                        <input id="inp-roll" type="text" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Total Qs</label>
                        <input id="inp-total" type="number" value="100" class="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded-lg border">
                    <div>
                        <label class="block text-xs font-bold text-green-600 uppercase mb-1">Correct (+4)</label>
                        <input id="inp-right" type="number" class="w-full border border-green-200 bg-white p-2 rounded font-bold text-green-700 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-red-600 uppercase mb-1">Wrong (-1)</label>
                        <input id="inp-wrong" type="number" class="w-full border border-red-200 bg-white p-2 rounded font-bold text-red-700 outline-none">
                    </div>
                </div>
                <button onclick="saveStudent()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition">Save Record</button>
            </div>
        </div>
    </div>

    <!-- MODAL FOR EXAM CONFIGURATION -->
    <div id="modal-exam-config" class="fixed inset-0 modal-bg hidden z-50 flex items-center justify-center fade-in">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden m-4 max-h-[90vh] overflow-y-auto">
            <div class="bg-purple-600 p-4 flex justify-between items-center text-white sticky top-0 z-10">
                <h3 class="font-bold"><i class="fas fa-cog mr-2"></i>Exam Configuration</h3>
                <button onclick="closeExamConfigModal()" class="hover:text-gray-300"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <!-- Results Live Control -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-xl p-4 mb-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <label class="block text-sm font-bold text-green-800 mb-1">
                                <i class="fas fa-broadcast-tower mr-2"></i>Results Publication Status
                            </label>
                            <p class="text-xs text-green-700">Control whether students can view results</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-bold text-gray-600" id="live-status-text">STOPPED</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="config-results-live" class="sr-only peer" onchange="updateLiveStatusText()">
                                <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-600"></div>
                            </label>
                            <span class="text-xs font-bold text-green-600 hidden" id="live-indicator">LIVE</span>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Exam Name</label>
                    <input id="config-exam-name" type="text" placeholder="e.g., Annual Board Examination 2026" class="w-full border p-2 rounded focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Institution Name</label>
                    <input id="config-institution" type="text" placeholder="e.g., ABC High School" class="w-full border p-2 rounded focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Exam Year</label>
                        <input id="config-year" type="number" placeholder="2026" class="w-full border p-2 rounded focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Exam Date</label>
                        <input id="config-date" type="date" class="w-full border p-2 rounded focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Subject/Class</label>
                    <input id="config-subject" type="text" placeholder="e.g., Mathematics - Grade 10" class="w-full border p-2 rounded focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4 bg-purple-50 p-3 rounded-lg border border-purple-200">
                    <div>
                        <label class="block text-xs font-bold text-purple-700 uppercase mb-1">Pass Percentage</label>
                        <input id="config-pass-percent" type="number" value="35" min="0" max="100" class="w-full border p-2 rounded font-bold outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-purple-700 uppercase mb-1">Marks Per Q (+)</label>
                        <input id="config-marks-positive" type="number" value="4" class="w-full border p-2 rounded font-bold outline-none">
                    </div>
                </div>
                <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                    <label class="block text-xs font-bold text-red-700 uppercase mb-1">Negative Marking (-)</label>
                    <input id="config-marks-negative" type="number" value="1" class="w-full border p-2 rounded font-bold outline-none">
                </div>
                
                <!-- Password Recovery Email -->
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                    <label class="block text-xs font-bold text-blue-700 uppercase mb-1">
                        <i class="fas fa-envelope mr-1"></i>Recovery Email (Optional)
                    </label>
                    <input id="config-recovery-email" type="email" placeholder="admin@school.com" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-blue-600 mt-1">Used for password recovery</p>
                </div>

                <button onclick="saveExamConfig()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition">
                    <i class="fas fa-save mr-2"></i>Save Configuration
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION SYSTEM ---
        let examConfig = JSON.parse(localStorage.getItem('exam_config')) || {
            examName: "Annual Board Examination 2026",
            institution: "ExamPortal Elite",
            year: 2026,
            date: "2026-03-15",
            subject: "General Knowledge",
            passPercent: 35,
            markingPositive: 4,
            markingNegative: 1,
            adminPass: "Rajganj@020240",
            resultsLive: false, // Results visibility control
            recoveryEmail: "" // Password recovery email
        };

        // --- STATE MANAGEMENT ---
        let students = JSON.parse(localStorage.getItem('exam_data')) || [
            { roll: "1003", name: "Ananya Gupta", total: 100, right: 92, wrong: 3 }
        ];
        let currentViewStudent = null;
        
        // --- ADMIN SESSION MANAGEMENT ---
        let adminSessionTimeout = null;
        const SESSION_DURATION = 30 * 60 * 1000; // 30 minutes in milliseconds

        // --- INITIALIZATION ---
        window.onload = () => {
            recalculateRanks();
            loadExamConfig();
        };

        function loadExamConfig() {
            document.getElementById('nav-title').innerText = examConfig.institution;
            document.getElementById('exam-title-display').innerText = examConfig.examName;
            document.getElementById('exam-subtitle-display').innerText = `${examConfig.subject} - ${examConfig.year}`;
            
            // Check results live status
            checkResultsLiveStatus();
        }

        function checkResultsLiveStatus() {
            const isLive = examConfig.resultsLive;
            const notLiveDiv = document.getElementById('results-not-live');
            const searchInterface = document.getElementById('search-interface');
            
            if (isLive) {
                notLiveDiv.classList.add('hidden');
                searchInterface.classList.remove('hidden');
            } else {
                notLiveDiv.classList.remove('hidden');
                searchInterface.classList.add('hidden');
                
                // Update waiting message
                document.getElementById('results-wait-exam').innerText = examConfig.examName;
                document.getElementById('results-wait-count').innerText = students.length;
            }
        }

        // --- CORE LOGIC ---
        function recalculateRanks() {
            students = students.map(s => {
                const marks = (s.right * examConfig.markingPositive) - (s.wrong * examConfig.markingNegative);
                const maxMarks = s.total * examConfig.markingPositive;
                const percent = ((marks / maxMarks) * 100).toFixed(2);
                return { ...s, marks, percent };
            });

            students.sort((a, b) => b.marks - a.marks);
            students.forEach((s, i) => s.rank = i + 1);

            localStorage.setItem('exam_data', JSON.stringify(students));
            renderAdminTable();
            document.getElementById('total-count').innerText = students.length;
        }

        // --- UI NAVIGATION ---
        function switchView(viewName) {
            ['view-student', 'view-login', 'view-dashboard'].forEach(id => 
                document.getElementById(id).classList.add('hidden'));
            
            if(viewName === 'student') {
                document.getElementById('view-student').classList.remove('hidden');
                document.getElementById('result-display').classList.add('hidden');
                document.getElementById('search-input').value = '';
            }
            if(viewName === 'login') document.getElementById('view-login').classList.remove('hidden');
            if(viewName === 'dashboard') document.getElementById('view-dashboard').classList.remove('hidden');
        }

        function notif(msg, type = 'info') {
            const t = document.getElementById('toast');
            const icon = document.querySelector('#toast i');
            
            icon.className = type === 'success' ? 'fas fa-check-circle text-green-400' : 
                             type === 'error' ? 'fas fa-exclamation-circle text-red-400' : 
                             'fas fa-info-circle text-indigo-400';
            
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 3000);
        }

        // --- STUDENT SEARCH FEATURE ---
        function findStudent() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            
            if(!query) {
                notif('Please enter a roll number or name', 'error');
                return;
            }

            const s = students.find(st => 
                st.roll.toString().toLowerCase() === query || 
                st.name.toLowerCase().includes(query)
            );
            
            if(s) {
                currentViewStudent = s;
                document.getElementById('search-error').classList.add('hidden');
                document.getElementById('result-display').classList.remove('hidden');
                
                const attempted = s.right + s.wrong;
                
                document.getElementById('disp-name').innerText = s.name;
                document.getElementById('disp-roll').innerText = s.roll;
                document.getElementById('disp-rank').innerText = "#" + s.rank;
                document.getElementById('disp-total').innerText = s.total;
                document.getElementById('disp-attempted').innerText = attempted;
                document.getElementById('disp-right').innerText = s.right;
                document.getElementById('disp-wrong').innerText = s.wrong;
                document.getElementById('disp-marks').innerText = s.marks;
                document.getElementById('disp-percent').innerText = s.percent + "%";
                
                const badge = document.getElementById('disp-badge');
                const isPassed = parseFloat(s.percent) >= examConfig.passPercent;
                badge.innerText = isPassed ? "PASSED" : "FAILED";
                badge.className = isPassed 
                    ? "px-3 py-1 rounded-full text-sm font-bold uppercase bg-green-100 text-green-700"
                    : "px-3 py-1 rounded-full text-sm font-bold uppercase bg-red-100 text-red-700";
            } else {
                document.getElementById('result-display').classList.add('hidden');
                document.getElementById('search-error').classList.remove('hidden');
            }
        }

        // --- WHATSAPP SHARE ---
        function shareResultWhatsApp() {
            if(!currentViewStudent) return;
            const s = currentViewStudent;
            
            const message = `ðŸ† Exam Result Update

Name: ${s.name}
Roll No: ${s.roll}
Rank: #${s.rank}

âœ… Score: ${s.marks} (${s.percent}%)

Check full details on the portal!
${window.location.href}`;

            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        // --- HIGH DEFINITION A4 JPG RESULT GENERATION ---
        async function generateResultJPG(source) {
            const student = source === 'student' ? currentViewStudent : 
                            source === 'admin' ? students.find(s => s.roll === currentViewStudent?.roll) : null;
            
            if(!student) {
                notif('No student data found', 'error');
                return;
            }

            notif('Generating HD Result Card...', 'info');

            // Generate unique verification code
            const verificationCode = `VER${student.roll}${Date.now().toString().slice(-6)}`;
            const qrData = `${window.location.origin}?verify=${verificationCode}&roll=${student.roll}`;
            
            // Calculate attempted questions
            const attempted = student.right + student.wrong;
            const unattempted = student.total - attempted;

            // Create A4 Result Card
            const html = `
                <div class="result-card-a4">
                    <div class="watermark-bg">${examConfig.institution}</div>
                    
                    <!-- QR CODE - TOP RIGHT CORNER WITH HIGH VISIBILITY -->
                    <div style="position: absolute; top: 30px; right: 30px; z-index: 1000;">
                        <div style="background: white; padding: 15px; border-radius: 15px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); border: 4px solid #4f46e5;">
                            <div id="qr-container-${student.roll}" style="margin-bottom: 10px; background: white; padding: 8px; border-radius: 8px;"></div>
                            <div style="text-align: center; background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; letter-spacing: 0.5px;">
                                SCAN TO VERIFY
                            </div>
                            <div style="text-align: center; margin-top: 8px; font-size: 9px; color: #111827; font-family: monospace; font-weight: bold; background: #f3f4f6; padding: 4px; border-radius: 4px;">
                                ${verificationCode}
                            </div>
                        </div>
                    </div>
                    
                    <!-- HEADER -->
                    <div style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); padding: 45px 40px; padding-right: 220px; text-align: center; color: white; position: relative;">
                        <div style="position: absolute; top: 15px; left: 30px; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 11px; font-weight: bold;">
                            OFFICIAL RESULT CARD
                        </div>
                        <h1 style="font-size: 34px; font-weight: bold; margin: 0 0 12px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">${examConfig.institution}</h1>
                        <p style="font-size: 19px; margin: 0; opacity: 0.95; font-weight: 600;">${examConfig.examName}</p>
                        <p style="font-size: 14px; margin: 8px 0 0 0; opacity: 0.85;">${examConfig.subject} â€¢ Year: ${examConfig.year} â€¢ Date: ${new Date(examConfig.date).toLocaleDateString('en-IN')}</p>
                    </div>

                    <!-- BODY -->
                    <div style="padding: 35px 40px; padding-bottom: 120px;">
                        <!-- Student Info -->
                        <div style="background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); border: 3px solid #e5e7eb; border-radius: 15px; padding: 28px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                                <div>
                                    <p style="font-size: 11px; color: #6b7280; font-weight: bold; text-transform: uppercase; margin: 0 0 8px 0; letter-spacing: 1px;">Student Name</p>
                                    <p style="font-size: 26px; font-weight: bold; color: #111827; margin: 0; line-height: 1.2;">${student.name}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="font-size: 11px; color: #6b7280; font-weight: bold; text-transform: uppercase; margin: 0 0 8px 0; letter-spacing: 1px;">Roll Number</p>
                                    <p style="font-size: 26px; font-weight: bold; color: #4f46e5; margin: 0; font-family: monospace; line-height: 1.2;">${student.roll}</p>
                                </div>
                            </div>
                            <div style="border-top: 3px dashed #d1d5db; padding-top: 25px; text-align: center;">
                                <p style="font-size: 13px; color: #6b7280; margin: 0 0 8px 0; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Overall Rank</p>
                                <p style="font-size: 52px; font-weight: bold; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; text-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);">#${student.rank}</p>
                            </div>
                        </div>

                        <!-- Performance Stats - 5 Columns with Attempted -->
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 25px;">
                            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 18px 12px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.04);">
                                <p style="font-size: 10px; color: #6b7280; font-weight: bold; margin: 0 0 10px 0; text-transform: uppercase;">Total Qs</p>
                                <p style="font-size: 26px; font-weight: bold; color: #111827; margin: 0;">${student.total}</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 18px 12px; text-align: center; box-shadow: 0 2px 6px rgba(59,130,246,0.1);">
                                <p style="font-size: 10px; color: #1d4ed8; font-weight: bold; margin: 0 0 10px 0; text-transform: uppercase;">Attempted</p>
                                <p style="font-size: 26px; font-weight: bold; color: #1d4ed8; margin: 0;">${attempted}</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%); border: 2px solid #22c55e; border-radius: 12px; padding: 18px 12px; text-align: center; box-shadow: 0 2px 6px rgba(34,197,94,0.1);">
                                <p style="font-size: 10px; color: #15803d; font-weight: bold; margin: 0 0 10px 0; text-transform: uppercase;">Correct</p>
                                <p style="font-size: 26px; font-weight: bold; color: #15803d; margin: 0;">${student.right}</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%); border: 2px solid #ef4444; border-radius: 12px; padding: 18px 12px; text-align: center; box-shadow: 0 2px 6px rgba(239,68,68,0.1);">
                                <p style="font-size: 10px; color: #b91c1c; font-weight: bold; margin: 0 0 10px 0; text-transform: uppercase;">Wrong</p>
                                <p style="font-size: 26px; font-weight: bold; color: #b91c1c; margin: 0;">${student.wrong}</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%); border: 2px solid #6366f1; border-radius: 12px; padding: 18px 12px; text-align: center; box-shadow: 0 2px 6px rgba(99,102,241,0.1);">
                                <p style="font-size: 10px; color: #4338ca; font-weight: bold; margin: 0 0 10px 0; text-transform: uppercase;">Marks</p>
                                <p style="font-size: 26px; font-weight: bold; color: #4338ca; margin: 0;">${student.marks}</p>
                            </div>
                        </div>

                        <!-- Final Result -->
                        <div style="background: ${parseFloat(student.percent) >= examConfig.passPercent ? 'linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%)' : 'linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%)'}; border: 4px solid ${parseFloat(student.percent) >= examConfig.passPercent ? '#16a34a' : '#dc2626'}; border-radius: 15px; padding: 35px; text-align: center; margin-bottom: 25px; box-shadow: 0 6px 20px ${parseFloat(student.percent) >= examConfig.passPercent ? 'rgba(22,163,74,0.15)' : 'rgba(220,38,38,0.15)'};">
                            <p style="font-size: 15px; color: #374151; font-weight: bold; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 1.5px;">Percentage Scored</p>
                            <p style="font-size: 64px; font-weight: bold; color: ${parseFloat(student.percent) >= examConfig.passPercent ? '#16a34a' : '#dc2626'}; margin: 0 0 18px 0; line-height: 1; text-shadow: 0 2px 8px ${parseFloat(student.percent) >= examConfig.passPercent ? 'rgba(22,163,74,0.2)' : 'rgba(220,38,38,0.2)'};">${student.percent}%</p>
                            <div style="display: inline-block; background: ${parseFloat(student.percent) >= examConfig.passPercent ? '#16a34a' : '#dc2626'}; color: white; padding: 14px 50px; border-radius: 50px; font-size: 22px; font-weight: bold; box-shadow: 0 4px 12px ${parseFloat(student.percent) >= examConfig.passPercent ? 'rgba(22,163,74,0.3)' : 'rgba(220,38,38,0.3)'}; letter-spacing: 1px;">
                                ${parseFloat(student.percent) >= examConfig.passPercent ? 'âœ“ PASSED' : 'âœ— FAILED'}
                            </div>
                        </div>

                        <!-- Additional Info -->
                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="font-size: 11px; color: #92400e; margin: 0; font-weight: 600;">
                                <strong>Marking Scheme:</strong> Correct: +${examConfig.markingPositive} | Wrong: -${examConfig.markingNegative} | Unattempted: ${unattempted} Questions
                            </p>
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <div style="background: #111827; color: white; padding: 22px 40px; text-align: center; position: absolute; bottom: 0; width: 100%; box-sizing: border-box;">
                        <p style="font-size: 12px; margin: 0 0 6px 0; font-weight: 500;">ðŸ“… Date of Issue: ${new Date().toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' })} | This is a computer-generated result</p>
                        <p style="font-size: 10px; color: #9ca3af; margin: 0;">Powered by ${examConfig.institution} - ExamPortal Elite System | Verify authenticity by scanning QR code</p>
                    </div>
                </div>
            `;

            const captureZone = document.getElementById('capture-zone');
            captureZone.innerHTML = html;

            // Generate QR Code with larger size for better scanning
            const qrContainer = document.getElementById(`qr-container-${student.roll}`);
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: qrData,
                width: 140,
                height: 140,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H // Highest error correction
            });

            // Wait for QR to render
            await new Promise(resolve => setTimeout(resolve, 800));

            // Capture as high-res JPG
            html2canvas(captureZone.querySelector('.result-card-a4'), {
                scale: 4, // ULTRA HD - 4x resolution
                useCORS: true,
                backgroundColor: '#ffffff',
                width: 794,
                height: 1123
            }).then(canvas => {
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Result_${student.name.replace(/\s+/g, '_')}_${student.roll}.jpg`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    notif('âœ“ Result card downloaded successfully!', 'success');
                    captureZone.innerHTML = '';
                }, 'image/jpeg', 0.98); // Higher quality
            });
        }

        // --- MERIT LIST JPG GENERATION ---
        async function generateMeritListJPG() {
            if(students.length === 0) {
                notif('No students found', 'error');
                return;
            }

            notif('Generating Ultra HD Merit List with ALL students...', 'info');

            const topStudents = students; // ALL STUDENTS

            const rows = topStudents.map((s, i) => `
                <tr style="border-bottom: 1px solid #e5e7eb; ${i % 2 === 0 ? 'background: #f9fafb;' : 'background: white;'}">
                    <td style="padding: 12px; text-align: center; font-weight: bold; color: ${s.rank <= 3 ? '#fbbf24' : s.rank <= 10 ? '#60a5fa' : '#111827'};">${s.rank}</td>
                    <td style="padding: 12px; font-family: monospace; font-weight: bold;">${s.roll}</td>
                    <td style="padding: 12px; font-weight: 600;">${s.name}</td>
                    <td style="padding: 12px; text-align: center; font-weight: bold; color: #4f46e5;">${s.marks}</td>
                    <td style="padding: 12px; text-align: center; font-weight: bold; color: #16a34a;">${s.percent}%</td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; background: ${parseFloat(s.percent) >= examConfig.passPercent ? '#dcfce7' : '#fee2e2'}; color: ${parseFloat(s.percent) >= examConfig.passPercent ? '#16a34a' : '#dc2626'};">
                            ${parseFloat(s.percent) >= examConfig.passPercent ? 'PASS' : 'FAIL'}
                        </span>
                    </td>
                </tr>
            `).join('');

            const html = `
                <div class="result-card-a4" style="height: auto; min-height: 1123px;">
                    <div class="watermark-bg">MERIT LIST</div>
                    
                    <div style="background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%); padding: 35px; text-align: center; color: white;">
                        <h1 style="font-size: 36px; font-weight: bold; margin: 0 0 10px 0;">ðŸ† MERIT LIST ðŸ†</h1>
                        <p style="font-size: 20px; margin: 0;">${examConfig.examName}</p>
                        <p style="font-size: 14px; margin: 8px 0 0 0; opacity: 0.9;">${examConfig.institution} | ${examConfig.year}</p>
                    </div>

                    <div style="padding: 30px; padding-bottom: 100px;">
                        <div style="background: #f9fafb; border-left: 4px solid #4f46e5; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                            <p style="font-size: 14px; color: #374151; margin: 0; font-weight: 600;">
                                <strong>Subject:</strong> ${examConfig.subject} | 
                                <strong>Date:</strong> ${new Date(examConfig.date).toLocaleDateString('en-IN')} | 
                                <strong>Total Students:</strong> ${students.length} | 
                                <strong>Showing:</strong> ALL RANKS
                            </p>
                        </div>

                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background: #111827; color: white;">
                                    <th style="padding: 14px; text-align: center; font-size: 12px; text-transform: uppercase;">Rank</th>
                                    <th style="padding: 14px; font-size: 12px; text-transform: uppercase;">Roll</th>
                                    <th style="padding: 14px; font-size: 12px; text-transform: uppercase;">Name</th>
                                    <th style="padding: 14px; text-align: center; font-size: 12px; text-transform: uppercase;">Marks</th>
                                    <th style="padding: 14px; text-align: center; font-size: 12px; text-transform: uppercase;">%</th>
                                    <th style="padding: 14px; text-align: center; font-size: 12px; text-transform: uppercase;">Status</th>
                                </tr>
                            </thead>
                            <tbody style="background: white;">
                                ${rows}
                            </tbody>
                        </table>

                        <div style="margin-top: 30px; padding: 20px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; text-align: center;">
                            <p style="font-size: 12px; color: #92400e; margin: 0; font-weight: bold;">
                                ðŸŒŸ Congratulations to all ${students.length} students! ðŸŒŸ
                            </p>
                        </div>
                    </div>

                    <div style="background: #111827; color: white; padding: 15px 30px; text-align: center; margin-top: 30px;">
                        <p style="font-size: 11px; margin: 0;">Generated on: ${new Date().toLocaleString('en-IN')} | ${examConfig.institution}</p>
                        <p style="font-size: 10px; color: #9ca3af; margin: 5px 0 0 0;">Complete Merit List - All ${students.length} Students Ranked</p>
                    </div>
                </div>
            `;

            const captureZone = document.getElementById('capture-zone');
            captureZone.innerHTML = html;

            await new Promise(resolve => setTimeout(resolve, 300));

            // Calculate dynamic height based on number of students
            const baseHeight = 400; // Header + footer
            const rowHeight = 45; // Each student row
            const totalHeight = Math.max(1123, baseHeight + (topStudents.length * rowHeight));

            html2canvas(captureZone.querySelector('.result-card-a4'), {
                scale: 4, // ULTRA HD - 4x resolution
                useCORS: true,
                backgroundColor: '#ffffff',
                width: 794,
                height: totalHeight,
                windowHeight: totalHeight
            }).then(canvas => {
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Merit_List_${examConfig.examName.replace(/\s+/g, '_')}_ALL_${students.length}_Students.jpg`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    notif(`âœ“ Merit list with ${students.length} students downloaded!`, 'success');
                    captureZone.innerHTML = '';
                }, 'image/jpeg', 0.98); // Higher quality
            });
        }

        // --- ADMIN SESSION MANAGEMENT FUNCTIONS ---
        function startAdminSession() {
            resetSessionTimeout();
            updateSessionTimer();
        }

        function resetSessionTimeout() {
            // Clear existing timeout
            if (adminSessionTimeout) {
                clearTimeout(adminSessionTimeout);
            }
            
            // Set new timeout
            adminSessionTimeout = setTimeout(() => {
                autoLogout();
            }, SESSION_DURATION);
            
            // Store session start time
            sessionStorage.setItem('admin_session_start', Date.now());
        }

        function updateSessionTimer() {
            const timerElement = document.getElementById('session-timer');
            if (!timerElement) return;
            
            const sessionStart = parseInt(sessionStorage.getItem('admin_session_start') || Date.now());
            const elapsed = Date.now() - sessionStart;
            const remaining = Math.max(0, SESSION_DURATION - elapsed);
            
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            
            timerElement.innerText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Update color based on time remaining
            const container = timerElement.closest('div');
            if (remaining < 5 * 60 * 1000) { // Less than 5 minutes
                container.className = 'mt-3 inline-flex items-center gap-2 bg-red-50 border border-red-200 px-4 py-2 rounded-lg';
                timerElement.className = 'text-sm font-semibold text-red-800';
            } else if (remaining < 10 * 60 * 1000) { // Less than 10 minutes
                container.className = 'mt-3 inline-flex items-center gap-2 bg-yellow-50 border border-yellow-200 px-4 py-2 rounded-lg';
                timerElement.className = 'text-sm font-semibold text-yellow-800';
            }
            
            // Continue updating if in dashboard
            if (document.getElementById('view-dashboard').classList.contains('hidden') === false) {
                setTimeout(updateSessionTimer, 1000);
            }
        }

        function autoLogout() {
            notif('Session expired. Please login again.', 'error');
            logout();
        }

        // --- ADMIN FEATURES ---
        function handleLogin() {
            const p = document.getElementById('admin-pass').value;
            if(p === examConfig.adminPass) {
                switchView('dashboard');
                startAdminSession(); // Start session timer
                document.getElementById('admin-pass').value = '';
                document.getElementById('login-msg').classList.add('hidden');
            } else {
                document.getElementById('login-msg').classList.remove('hidden');
            }
        }

        function logout() {
            // Clear session timeout
            if (adminSessionTimeout) {
                clearTimeout(adminSessionTimeout);
                adminSessionTimeout = null;
            }
            sessionStorage.removeItem('admin_session_start');
            
            switchView('student');
            notif('Logged out successfully', 'success');
        }

        function renderAdminTable() {
            const searchQuery = document.getElementById('admin-search')?.value.toLowerCase() || '';
            
            const filtered = students.filter(s => 
                s.roll.toString().toLowerCase().includes(searchQuery) || 
                s.name.toLowerCase().includes(searchQuery)
            );

            const tbody = document.getElementById('admin-tbody');
            tbody.innerHTML = filtered.map(s => {
                const isPassed = parseFloat(s.percent) >= examConfig.passPercent;
                return `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="p-4 text-center font-bold ${s.rank <= 3 ? 'text-yellow-500' : 'text-gray-800'}">#${s.rank}</td>
                        <td class="p-4 font-mono font-bold">${s.roll}</td>
                        <td class="p-4 font-semibold">${s.name}</td>
                        <td class="p-4 text-center font-bold text-indigo-600">${s.marks}</td>
                        <td class="p-4 text-center font-bold text-green-600">${s.percent}%</td>
                        <td class="p-4 text-center">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${isPassed ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                ${isPassed ? 'PASS' : 'FAIL'}
                            </span>
                        </td>
                        <td class="p-4 text-center">
                            <button onclick="editStudent('${s.roll}')" class="text-blue-600 hover:text-blue-800 mx-1" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="viewStudentResult('${s.roll}')" class="text-green-600 hover:text-green-800 mx-1" title="View Result">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="deleteStudent('${s.roll}')" class="text-red-600 hover:text-red-800 mx-1" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewStudentResult(roll) {
            const s = students.find(st => st.roll === roll);
            if(s) {
                currentViewStudent = s;
                generateResultJPG('admin');
            }
        }

        function openPasswordRecovery() {
            document.getElementById('modal-password-recovery').classList.remove('hidden');
            const recoveryEmail = examConfig.recoveryEmail || 'Not configured';
            document.getElementById('recovery-email-display').innerText = recoveryEmail;
        }

        function closePasswordRecovery() {
            document.getElementById('modal-password-recovery').classList.add('hidden');
        }

        function updateLiveStatusText() {
            const checkbox = document.getElementById('config-results-live');
            const statusText = document.getElementById('live-status-text');
            const liveIndicator = document.getElementById('live-indicator');
            
            if (checkbox.checked) {
                statusText.classList.add('hidden');
                liveIndicator.classList.remove('hidden');
            } else {
                statusText.classList.remove('hidden');
                liveIndicator.classList.add('hidden');
            }
        }

        function openModal(type) {
            if(type === 'exam-config') {
                resetSessionTimeout(); // Reset timer on admin activity
                document.getElementById('modal-exam-config').classList.remove('hidden');
                document.getElementById('config-exam-name').value = examConfig.examName;
                document.getElementById('config-institution').value = examConfig.institution;
                document.getElementById('config-year').value = examConfig.year;
                document.getElementById('config-date').value = examConfig.date;
                document.getElementById('config-subject').value = examConfig.subject;
                document.getElementById('config-pass-percent').value = examConfig.passPercent;
                document.getElementById('config-marks-positive').value = examConfig.markingPositive;
                document.getElementById('config-marks-negative').value = examConfig.markingNegative;
                document.getElementById('config-results-live').checked = examConfig.resultsLive || false;
                document.getElementById('config-recovery-email').value = examConfig.recoveryEmail || '';
                updateLiveStatusText();
                return;
            }

            resetSessionTimeout(); // Reset timer on admin activity
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = type === 'add' ? 'Add Student' : 'Edit Student';
            
            if(type === 'add') {
                document.getElementById('edit-roll-ref').value = '';
                document.getElementById('inp-name').value = '';
                document.getElementById('inp-roll').value = '';
                document.getElementById('inp-total').value = 100;
                document.getElementById('inp-right').value = '';
                document.getElementById('inp-wrong').value = '';
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function closeExamConfigModal() {
            document.getElementById('modal-exam-config').classList.add('hidden');
        }

        function saveExamConfig() {
            resetSessionTimeout(); // Reset timer on admin activity
            
            examConfig.examName = document.getElementById('config-exam-name').value;
            examConfig.institution = document.getElementById('config-institution').value;
            examConfig.year = parseInt(document.getElementById('config-year').value);
            examConfig.date = document.getElementById('config-date').value;
            examConfig.subject = document.getElementById('config-subject').value;
            examConfig.passPercent = parseFloat(document.getElementById('config-pass-percent').value);
            examConfig.markingPositive = parseFloat(document.getElementById('config-marks-positive').value);
            examConfig.markingNegative = parseFloat(document.getElementById('config-marks-negative').value);
            examConfig.resultsLive = document.getElementById('config-results-live').checked;
            examConfig.recoveryEmail = document.getElementById('config-recovery-email').value;

            localStorage.setItem('exam_config', JSON.stringify(examConfig));
            
            loadExamConfig();
            recalculateRanks();
            closeExamConfigModal();
            
            const statusMsg = examConfig.resultsLive ? 'Results are now LIVE for students!' : 'Results visibility STOPPED for students';
            notif(`âœ“ Exam configuration updated! ${statusMsg}`, 'success');
        }

        function editStudent(roll) {
            resetSessionTimeout(); // Reset timer on admin activity
            const s = students.find(st => st.roll === roll);
            if(s) {
                openModal('edit');
                document.getElementById('edit-roll-ref').value = s.roll;
                document.getElementById('inp-name').value = s.name;
                document.getElementById('inp-roll').value = s.roll;
                document.getElementById('inp-total').value = s.total;
                document.getElementById('inp-right').value = s.right;
                document.getElementById('inp-wrong').value = s.wrong;
            }
        }

        function saveStudent() {
            resetSessionTimeout(); // Reset timer on admin activity
            
            const name = document.getElementById('inp-name').value.trim();
            const roll = document.getElementById('inp-roll').value.trim();
            const total = parseInt(document.getElementById('inp-total').value);
            const right = parseInt(document.getElementById('inp-right').value);
            const wrong = parseInt(document.getElementById('inp-wrong').value);

            if(!name || !roll || isNaN(total) || isNaN(right) || isNaN(wrong)) {
                notif('Please fill all fields correctly', 'error');
                return;
            }

            const editRef = document.getElementById('edit-roll-ref').value;
            
            if(editRef) {
                const idx = students.findIndex(s => s.roll === editRef);
                if(idx !== -1) {
                    students[idx] = { roll, name, total, right, wrong };
                    notif('âœ“ Student updated successfully', 'success');
                }
            } else {
                if(students.find(s => s.roll === roll)) {
                    notif('Roll number already exists', 'error');
                    return;
                }
                students.push({ roll, name, total, right, wrong });
                notif('âœ“ Student added successfully', 'success');
            }

            recalculateRanks();
            closeModal();
        }

        function deleteStudent(roll) {
            resetSessionTimeout(); // Reset timer on admin activity
            
            if(confirm('Are you sure you want to delete this student?')) {
                students = students.filter(s => s.roll !== roll);
                recalculateRanks();
                notif('âœ“ Student deleted', 'success');
            }
        }
    </script>
</body>
</html>

